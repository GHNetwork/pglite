"use strict";var be=Object.defineProperty;var Xe=Object.getOwnPropertyDescriptor;var Ze=Object.getOwnPropertyNames;var et=Object.prototype.hasOwnProperty;var ve=e=>{throw TypeError(e)};var tt=(e,t)=>{for(var r in t)be(e,r,{get:t[r],enumerable:!0})},rt=(e,t,r,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let i of Ze(t))!et.call(e,i)&&i!==r&&be(e,i,{get:()=>t[i],enumerable:!(n=Xe(t,i))||n.enumerable});return e};var nt=e=>rt(be({},"__esModule",{value:!0}),e);var we=(e,t,r)=>t.has(e)||ve("Cannot "+r);var a=(e,t,r)=>(we(e,t,"read from private field"),r?r.call(e):t.get(e)),d=(e,t,r)=>t.has(e)?ve("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(e):t.set(e,r),p=(e,t,r,n)=>(we(e,t,"write to private field"),n?n.call(e,r):t.set(e,r),r),l=(e,t,r)=>(we(e,t,"access private method"),r);var Pe=(e,t,r,n)=>({set _(i){p(e,t,i,r)},get _(){return a(e,t,n)}});var Zt={};tt(Zt,{LeaderChangedError:()=>he,PGliteWorker:()=>Le,worker:()=>Yt});module.exports=nt(Zt);var st=()=>typeof document>"u"?new URL(`file:${__filename}`).href:document.currentScript&&document.currentScript.tagName.toUpperCase()==="SCRIPT"?document.currentScript.src:new URL("main.js",document.baseURI).href,T=st();var Oe={part:"part",container:"container"};function le(e,t,...r){let n=e.length-1,i=r.length-1;if(i!==-1){if(i===0){e[n]=e[n]+r[0]+t;return}e[n]=e[n]+r[0],e.push(...r.slice(1,i)),e.push(r[i]+t)}}function at(e,...t){let r=[e[0]];r.raw=[e.raw[0]];let n=[];for(let i=0;i<t.length;i++){let s=t[i],o=i+1;if(s?._templateType===Oe.part){le(r,e[o],s.str),le(r.raw,e.raw[o],s.str);continue}if(s?._templateType===Oe.container){le(r,e[o],...s.strings),le(r.raw,e.raw[o],...s.strings.raw),n.push(...s.values);continue}r.push(e[o]),r.raw.push(e.raw[o]),n.push(s)}return{_templateType:"container",strings:r,values:n}}function xe(e,...t){let{strings:r,values:n}=at(e,...t);return{query:[r[0],...n.flatMap((i,s)=>[`$${s+1}`,r[s+1]])].join(""),params:n}}var it=globalThis.JSON.parse,ot=globalThis.JSON.stringify,We=16,Ne=17;var Ue=20,lt=21,ct=23;var Te=25,ut=26;var Fe=114;var dt=700,pt=701;var mt=1042,yt=1043,ft=1082;var ht=1114,_e=1184;var gt=3802;var bt={string:{to:Te,from:[Te,yt,mt],serialize:e=>{if(typeof e=="string")return e;if(typeof e=="number")return e.toString();throw new Error("Invalid input for string type")},parse:e=>e},number:{to:0,from:[lt,ct,ut,dt,pt],serialize:e=>e.toString(),parse:e=>+e},bigint:{to:Ue,from:[Ue],serialize:e=>e.toString(),parse:e=>{let t=BigInt(e);return t<Number.MIN_SAFE_INTEGER||t>Number.MAX_SAFE_INTEGER?t:Number(t)}},json:{to:Fe,from:[Fe,gt],serialize:e=>typeof e=="string"?e:ot(e),parse:e=>it(e)},boolean:{to:We,from:[We],serialize:e=>{if(typeof e!="boolean")throw new Error("Invalid input for boolean type");return e?"t":"f"},parse:e=>e==="t"},date:{to:_e,from:[ft,ht,_e],serialize:e=>{if(typeof e=="string")return e;if(typeof e=="number")return new Date(e).toISOString();if(e instanceof Date)return e.toISOString();throw new Error("Invalid input for date type")},parse:e=>new Date(e)},bytea:{to:Ne,from:[Ne],serialize:e=>{if(!(e instanceof Uint8Array))throw new Error("Invalid input for bytea type");return"\\x"+Array.from(e).map(t=>t.toString(16).padStart(2,"0")).join("")},parse:e=>{let t=e.slice(2);return Uint8Array.from({length:t.length/2},(r,n)=>parseInt(t.substring(n*2,(n+1)*2),16))}}},Ae=wt(bt),Qe=Ae.parsers,Ve=Ae.serializers;function Ie(e,t,r){if(e===null)return null;let n=r?.[t]??Ae.parsers[t];return n?n(e,t):e}function wt(e){return Object.keys(e).reduce(({parsers:t,serializers:r},n)=>{let{to:i,from:s,serialize:o,parse:u}=e[n];return r[i]=o,r[n]=o,t[n]=u,Array.isArray(s)?s.forEach(c=>{t[c]=u,r[c]=o}):(t[s]=u,r[s]=o),{parsers:t,serializers:r}},{parsers:{},serializers:{}})}var Pt=/\\/g,xt=/"/g;function kt(e){return e.replace(Pt,"\\\\").replace(xt,'\\"')}function Ee(e,t,r){if(Array.isArray(e)===!1)return e;if(!e.length)return"{}";let n=e[0],i=r===1020?";":",";return Array.isArray(n)?`{${e.map(s=>Ee(s,t,r)).join(i)}}`:`{${e.map(s=>(s===void 0&&(s=null),s===null?"null":'"'+kt(t?t(s):s.toString())+'"')).join(i)}}`}var ke={i:0,char:null,str:"",quoted:!1,last:0,p:null};function qe(e,t,r){return ke.i=ke.last=0,ze(ke,e,t,r)[0]}function ze(e,t,r,n){let i=[],s=n===1020?";":",";for(;e.i<t.length;e.i++){if(e.char=t[e.i],e.quoted)e.char==="\\"?e.str+=t[++e.i]:e.char==='"'?(i.push(r?r(e.str):e.str),e.str="",e.quoted=t[e.i+1]==='"',e.last=e.i+2):e.str+=e.char;else if(e.char==='"')e.quoted=!0;else if(e.char==="{")e.last=++e.i,i.push(ze(e,t,r,n));else if(e.char==="}"){e.quoted=!1,e.last<e.i&&i.push(r?r(t.slice(e.last,e.i)):t.slice(e.last,e.i)),e.last=e.i+1;break}else e.char===s&&e.p!=="}"&&e.p!=='"'&&(i.push(r?r(t.slice(e.last,e.i)):t.slice(e.last,e.i)),e.last=e.i+1);e.p=e.char}return e.last<e.i&&i.push(r?r(t.slice(e.last,e.i+1)):t.slice(e.last,e.i+1)),i}function Re(e,t,r,n){let i=[],s={rows:[],fields:[]},o=0,u={...t,...r?.parsers};return e.forEach(c=>{switch(c.name){case"rowDescription":{let m=c;s.fields=m.fields.map(b=>({name:b.name,dataTypeID:b.dataTypeID}));break}case"dataRow":{if(!s)break;let m=c;r?.rowMode==="array"?s.rows.push(m.fields.map((b,k)=>Ie(b,s.fields[k].dataTypeID,u))):s.rows.push(Object.fromEntries(m.fields.map((b,k)=>[s.fields[k].name,Ie(b,s.fields[k].dataTypeID,u)])));break}case"commandComplete":{o+=Tt(c),i.push({...s,affectedRows:o,...n?{blob:n}:{}}),s={rows:[],fields:[]};break}}}),i.length===0&&i.push({affectedRows:0,rows:[],fields:[]}),i}function Tt(e){let t=e.text.split(" ");switch(t[0]){case"INSERT":return parseInt(t[2],10);case"UPDATE":case"DELETE":case"COPY":case"MERGE":return parseInt(t[1],10);default:return 0}}function Be(e){let t=e.find(r=>r.name==="parameterDescription");return t?t.dataTypeIDs:[]}function q(e){let t=e.length;for(let r=e.length-1;r>=0;r--){let n=e.charCodeAt(r);n>127&&n<=2047?t++:n>2047&&n<=65535&&(t+=2),n>=56320&&n<=57343&&r--}return t}var P,x,j,ue,H,A,ce,z,je,W=class{constructor(t=256){this.size=t;d(this,A);d(this,P);d(this,x,5);d(this,j,!1);d(this,ue,new TextEncoder);d(this,H,0);p(this,P,l(this,A,ce).call(this,t))}addInt32(t){return l(this,A,z).call(this,4),a(this,P).setInt32(a(this,x),t,a(this,j)),p(this,x,a(this,x)+4),this}addInt16(t){return l(this,A,z).call(this,2),a(this,P).setInt16(a(this,x),t,a(this,j)),p(this,x,a(this,x)+2),this}addCString(t){return t&&this.addString(t),l(this,A,z).call(this,1),a(this,P).setUint8(a(this,x),0),Pe(this,x)._++,this}addString(t=""){let r=q(t);return l(this,A,z).call(this,r),a(this,ue).encodeInto(t,new Uint8Array(a(this,P).buffer,a(this,x))),p(this,x,a(this,x)+r),this}add(t){let r=t instanceof Uint8Array?t.buffer.slice(t.byteOffset,t.byteOffset+t.byteLength):t;return l(this,A,z).call(this,r.byteLength),new Uint8Array(a(this,P).buffer).set(new Uint8Array(r),a(this,x)),p(this,x,a(this,x)+r.byteLength),this}flush(t){let r=l(this,A,je).call(this,t);return p(this,x,5),p(this,P,l(this,A,ce).call(this,this.size)),new Uint8Array(r)}};P=new WeakMap,x=new WeakMap,j=new WeakMap,ue=new WeakMap,H=new WeakMap,A=new WeakSet,ce=function(t){return new DataView(new ArrayBuffer(t))},z=function(t){if(a(this,P).byteLength-a(this,x)<t){let n=a(this,P).buffer,i=n.byteLength+(n.byteLength>>1)+t;p(this,P,l(this,A,ce).call(this,i)),new Uint8Array(a(this,P).buffer).set(new Uint8Array(n))}},je=function(t){if(t){a(this,P).setUint8(a(this,H),t);let r=a(this,x)-(a(this,H)+1);a(this,P).setInt32(a(this,H)+1,r,a(this,j))}return a(this,P).buffer.slice(t?0:5,a(this,x))};var g=new W,At=e=>{g.addInt16(3).addInt16(0);for(let n of Object.keys(e))g.addCString(n).addCString(e[n]);g.addCString("client_encoding").addCString("UTF8");let t=g.addCString("").flush(),r=t.byteLength+4;return new W().addInt32(r).add(t).flush()},It=()=>{let e=new DataView(new ArrayBuffer(8));return e.setInt32(0,8,!1),e.setInt32(4,80877103,!1),new Uint8Array(e.buffer)},Et=e=>g.addCString(e).flush(112),Rt=(e,t)=>(g.addCString(e).addInt32(q(t)).addString(t),g.flush(112)),Bt=e=>g.addString(e).flush(112),St=e=>g.addCString(e).flush(81),Dt=[],Mt=e=>{let t=e.name??"";t.length>63&&(console.error("Warning! Postgres only supports 63 characters for query names."),console.error("You supplied %s (%s)",t,t.length),console.error("This can cause conflicts and silent errors executing queries"));let r=g.addCString(t).addCString(e.text).addInt16(e.types?.length??0);return e.types?.forEach(n=>r.addInt32(n)),g.flush(80)},K=new W;var $t=(e,t)=>{for(let r=0;r<e.length;r++){let n=t?t(e[r],r):e[r];if(n===null)g.addInt16(0),K.addInt32(-1);else if(n instanceof ArrayBuffer||ArrayBuffer.isView(n)){let i=ArrayBuffer.isView(n)?n.buffer.slice(n.byteOffset,n.byteOffset+n.byteLength):n;g.addInt16(1),K.addInt32(i.byteLength),K.add(i)}else g.addInt16(0),K.addInt32(q(n)),K.addString(n)}},Lt=(e={})=>{let t=e.portal??"",r=e.statement??"",n=e.binary??!1,i=e.values??Dt,s=i.length;return g.addCString(t).addCString(r),g.addInt16(s),$t(i,e.valueMapper),g.addInt16(s),g.add(K.flush()),g.addInt16(n?1:0),g.flush(66)},Ct=new Uint8Array([69,0,0,0,9,0,0,0,0,0]),Gt=e=>{if(!e||!e.portal&&!e.rows)return Ct;let t=e.portal??"",r=e.rows??0,n=q(t),i=4+n+1+4,s=new DataView(new ArrayBuffer(1+i));return s.setUint8(0,69),s.setInt32(1,i,!1),new TextEncoder().encodeInto(t,new Uint8Array(s.buffer,5)),s.setUint8(n+5,0),s.setUint32(s.byteLength-4,r,!1),new Uint8Array(s.buffer)},vt=(e,t)=>{let r=new DataView(new ArrayBuffer(16));return r.setInt32(0,16,!1),r.setInt16(4,1234,!1),r.setInt16(6,5678,!1),r.setInt32(8,e,!1),r.setInt32(12,t,!1),new Uint8Array(r.buffer)},Se=(e,t)=>{let r=new W;return r.addCString(t),r.flush(e)},Ot=g.addCString("P").flush(68),Wt=g.addCString("S").flush(68),Nt=e=>e.name?Se(68,`${e.type}${e.name??""}`):e.type==="P"?Ot:Wt,Ut=e=>{let t=`${e.type}${e.name??""}`;return Se(67,t)},Ft=e=>g.add(e).flush(100),_t=e=>Se(102,e),de=e=>new Uint8Array([e,0,0,0,4]),Qt=de(72),Vt=de(83),qt=de(88),zt=de(99),I={startup:At,password:Et,requestSsl:It,sendSASLInitialResponseMessage:Rt,sendSCRAMClientFinalMessage:Bt,query:St,parse:Mt,bind:Lt,execute:Gt,describe:Nt,close:Ut,flush:()=>Qt,sync:()=>Vt,end:()=>qt,copyData:Ft,copyDone:()=>zt,copyFail:_t,cancel:vt};var N=class extends Error{constructor(r,n,i){super(r);this.length=n;this.name=i}};var kr=new ArrayBuffer(0);var Ht=1,Kt=4,ln=Ht+Kt,cn=new ArrayBuffer(0);function pe(e){let t=e.e;return t.query=e.query,t.params=e.params,t.queryOptions=e.options,t}var te,G,y,B,me,U,De,ye=class{constructor(){d(this,y);this.serializers={...Ve};this.parsers={...Qe};d(this,te,!1);d(this,G,!1)}async _initArrayTypes({force:t=!1}={}){if(a(this,te)&&!t)return;p(this,te,!0);let r=await this.query(`
      SELECT b.oid, b.typarray
      FROM pg_catalog.pg_type a
      LEFT JOIN pg_catalog.pg_type b ON b.oid = a.typelem
      WHERE a.typcategory = 'A'
      GROUP BY b.oid, b.typarray
      ORDER BY b.oid
    `);for(let n of r.rows)this.serializers[n.typarray]=i=>Ee(i,this.serializers[n.oid],n.typarray),this.parsers[n.typarray]=i=>qe(i,this.parsers[n.oid],n.typarray)}async refreshArrayTypes(){await this._initArrayTypes({force:!0})}async query(t,r,n){return await this._checkReady(),await this._runExclusiveTransaction(async()=>await l(this,y,me).call(this,t,r,n))}async sql(t,...r){let{query:n,params:i}=xe(t,...r);return await this.query(n,i)}async exec(t,r){return await this._checkReady(),await this._runExclusiveTransaction(async()=>await l(this,y,U).call(this,t,r))}async describeQuery(t,r){let n=[];try{await l(this,y,B).call(this,I.parse({text:t,types:r?.paramTypes}),r),n=await l(this,y,B).call(this,I.describe({type:"S"}),r)}catch(c){throw c instanceof N?pe({e:c,options:r,params:void 0,query:t}):c}finally{n.push(...await l(this,y,B).call(this,I.sync(),r))}let i=n.find(c=>c.name==="parameterDescription"),s=n.find(c=>c.name==="rowDescription"),o=i?.dataTypeIDs.map(c=>({dataTypeID:c,serializer:this.serializers[c]}))??[],u=s?.fields.map(c=>({name:c.name,dataTypeID:c.dataTypeID,parser:this.parsers[c.dataTypeID]}))??[];return{queryParams:o,resultFields:u}}async transaction(t){return await this._checkReady(),await this._runExclusiveTransaction(async()=>{await l(this,y,U).call(this,"BEGIN"),p(this,G,!0);let r=!1,n=()=>{if(r)throw new Error("Transaction is closed")},i={query:async(s,o,u)=>(n(),await l(this,y,me).call(this,s,o,u)),sql:async(s,...o)=>{let{query:u,params:c}=xe(s,...o);return await l(this,y,me).call(this,u,c)},exec:async(s,o)=>(n(),await l(this,y,U).call(this,s,o)),rollback:async()=>{n(),await l(this,y,U).call(this,"ROLLBACK"),r=!0},listen:async(s,o)=>(n(),await this.listen(s,o,i)),get closed(){return r}};try{let s=await t(i);return r||(r=!0,await l(this,y,U).call(this,"COMMIT")),p(this,G,!1),s}catch(s){throw r||await l(this,y,U).call(this,"ROLLBACK"),p(this,G,!1),s}})}async runExclusive(t){return await this._runExclusiveQuery(t)}};te=new WeakMap,G=new WeakMap,y=new WeakSet,B=async function(t,r={}){return await this.execProtocolStream(t,{...r,syncToFs:!1})},me=async function(t,r=[],n){return await this._runExclusiveQuery(async()=>{l(this,y,De).call(this,"runQuery",t,r,n),await this._handleBlob(n?.blob);let i=[];try{let o=await l(this,y,B).call(this,I.parse({text:t,types:n?.paramTypes}),n),u=Be(await l(this,y,B).call(this,I.describe({type:"S"}),n)),c=r.map((m,b)=>{let k=u[b];if(m==null)return null;let w=n?.serializers?.[k]??this.serializers[k];return w?w(m):m.toString()});i=[...o,...await l(this,y,B).call(this,I.bind({values:c}),n),...await l(this,y,B).call(this,I.describe({type:"P"}),n),...await l(this,y,B).call(this,I.execute({}),n)]}catch(o){throw o instanceof N?pe({e:o,options:n,params:r,query:t}):o}finally{i.push(...await l(this,y,B).call(this,I.sync(),n))}await this._cleanupBlob(),a(this,G)||await this.syncToFs();let s=await this._getWrittenBlob();return Re(i,this.parsers,n,s)[0]})},U=async function(t,r){return await this._runExclusiveQuery(async()=>{l(this,y,De).call(this,"runExec",t,r),await this._handleBlob(r?.blob);let n=[];try{n=await l(this,y,B).call(this,I.query(t),r)}catch(s){throw s instanceof N?pe({e:s,options:r,params:void 0,query:t}):s}finally{n.push(...await l(this,y,B).call(this,I.sync(),r))}this._cleanupBlob(),a(this,G)||await this.syncToFs();let i=await this._getWrittenBlob();return Re(n,this.parsers,r,i)})},De=function(...t){this.debug>0&&console.log(...t)};var Gn=typeof process=="object"&&typeof process.versions=="object"&&typeof process.versions.node=="string";var Me=()=>{if(globalThis.crypto?.randomUUID)return globalThis.crypto.randomUUID();let e=new Uint8Array(16);if(globalThis.crypto?.getRandomValues)globalThis.crypto.getRandomValues(e);else for(let r=0;r<e.length;r++)e[r]=Math.floor(Math.random()*256);e[6]=e[6]&15|64,e[8]=e[8]&63|128;let t=[];return e.forEach(r=>{t.push(r.toString(16).padStart(2,"0"))}),t.slice(0,4).join("")+"-"+t.slice(4,6).join("")+"-"+t.slice(6,8).join("")+"-"+t.slice(8,10).join("")+"-"+t.slice(10).join("")};function He(e){let t;return e.startsWith('"')&&e.endsWith('"')?t=e.substring(1,e.length-1):t=e.toLowerCase(),t}var Y,J,re,X,ne,R,v,F,D,Z,se,ae,_,L,ie,M,Q,ee,ge,h,Ke,fe,E,Ye,Ge=class Ge extends ye{constructor(r,n){super();d(this,h);d(this,Y);d(this,J,0);d(this,re,!1);d(this,X,!1);d(this,ne,!1);d(this,R,new EventTarget);d(this,v);d(this,F,!1);d(this,D);d(this,Z);d(this,se);d(this,ae);d(this,_);d(this,L);d(this,ie);d(this,M,new Map);d(this,Q,new Set);d(this,ee);d(this,ge,[]);p(this,D,r),p(this,v,Me()),p(this,ee,n?.extensions??{}),p(this,se,new Promise(i=>{a(this,D).addEventListener("message",s=>{if(s.data.type==="here")i();else throw new Error("Invalid message")},{once:!0})})),p(this,ae,new Promise(i=>{let s=o=>{o.data.type==="ready"&&(p(this,Z,o.data.id),a(this,D).removeEventListener("message",s),i())};a(this,D).addEventListener("message",s)})),p(this,Y,l(this,h,Ke).call(this,n))}static async create(r,n){let i=new Ge(r,n);return await a(i,Y),i}get waitReady(){return new Promise(r=>{a(this,Y).then(()=>{a(this,F)?r():r(new Promise(n=>{a(this,R).addEventListener("connected",()=>{n()})}))})})}get debug(){return a(this,J)}get ready(){return a(this,re)}get closed(){return a(this,X)}get isLeader(){return a(this,ne)}async close(){var r;a(this,X)||(p(this,X,!0),a(this,_)?.close(),a(this,L)?.close(),(r=a(this,ie))==null||r.call(this),a(this,D).terminate())}async[Symbol.asyncDispose](){await this.close()}async execProtocolRaw(r){return await l(this,h,E).call(this,"execProtocolRaw",r)}async execProtocol(r){return await l(this,h,E).call(this,"execProtocol",r)}async execProtocolStream(r){return await l(this,h,E).call(this,"execProtocolStream",r)}async syncToFs(){await l(this,h,E).call(this,"syncToFs")}async listen(r,n,i){let s=He(r),o=i??this;return a(this,M).has(s)||a(this,M).set(s,new Set),a(this,M).get(s).add(n),await o.exec(`LISTEN ${r}`),async u=>{await this.unlisten(s,n,u)}}async unlisten(r,n,i){await this.waitReady;let s=i??this;n?a(this,M).get(r)?.delete(n):a(this,M).delete(r),a(this,M).get(r)?.size===0&&await s.exec(`UNLISTEN ${r}`)}onNotification(r){return a(this,Q).add(r),()=>{a(this,Q).delete(r)}}offNotification(r){a(this,Q).delete(r)}async dumpDataDir(r){return await l(this,h,E).call(this,"dumpDataDir",r)}onLeaderChange(r){return a(this,R).addEventListener("leader-change",r),()=>{a(this,R).removeEventListener("leader-change",r)}}offLeaderChange(r){a(this,R).removeEventListener("leader-change",r)}async _handleBlob(r){await l(this,h,E).call(this,"_handleBlob",r)}async _getWrittenBlob(){return await l(this,h,E).call(this,"_getWrittenBlob")}async _cleanupBlob(){await l(this,h,E).call(this,"_cleanupBlob")}async _checkReady(){await this.waitReady}async _runExclusiveQuery(r){await l(this,h,E).call(this,"_acquireQueryLock");try{return await r()}finally{await l(this,h,E).call(this,"_releaseQueryLock")}}async _runExclusiveTransaction(r){await l(this,h,E).call(this,"_acquireTransactionLock");try{return await r()}finally{await l(this,h,E).call(this,"_releaseTransactionLock")}}};Y=new WeakMap,J=new WeakMap,re=new WeakMap,X=new WeakMap,ne=new WeakMap,R=new WeakMap,v=new WeakMap,F=new WeakMap,D=new WeakMap,Z=new WeakMap,se=new WeakMap,ae=new WeakMap,_=new WeakMap,L=new WeakMap,ie=new WeakMap,M=new WeakMap,Q=new WeakMap,ee=new WeakMap,ge=new WeakMap,h=new WeakSet,Ke=async function(r={}){let n=()=>typeof performance<"u"&&performance.now?performance.now():Date.now(),i=n(),s=()=>`+${(n()-i).toFixed(1)}ms`;console.info(`[PGliteInternal][worker-main] ${s()} ========== PGliteWorker #init START ==========`),console.debug(`[PGliteInternal][worker-main] ${s()} tabId=${a(this,v)}, dataDir=${r.dataDir??"memory://"}`);let o=Object.keys(a(this,ee)).length;console.debug(`[PGliteInternal][worker-main] ${s()} setting up ${o} extension(s) on client side...`);let u=n();for(let[f,oe]of Object.entries(a(this,ee))){if(oe instanceof URL)throw new Error("URL extensions are not supported on the client side of a worker");{let C=await oe.setup(this,{},!0);if(C.emscriptenOpts&&console.warn(`PGlite extension ${f} returned emscriptenOpts, these are not supported on the client side of a worker`),C.namespaceObj){let Je=this;Je[f]=C.namespaceObj}C.bundlePath&&console.warn(`PGlite extension ${f} returned bundlePath, this is not supported on the client side of a worker`),C.init&&await C.init(),C.close&&a(this,ge).push(C.close)}}console.debug(`[PGliteInternal][worker-main] ${s()} extensions setup completed (took ${(n()-u).toFixed(1)}ms)`),console.debug(`[PGliteInternal][worker-main] ${s()} awaiting workerHerePromise (waiting for worker to post 'here')...`);let c=n();await a(this,se),console.info(`[PGliteInternal][worker-main] ${s()} workerHerePromise resolved (waited ${(n()-c).toFixed(1)}ms)`);let{extensions:m,...b}=r;console.debug(`[PGliteInternal][worker-main] ${s()} posting 'init' message to worker with options`),a(this,D).postMessage({type:"init",options:b}),console.debug(`[PGliteInternal][worker-main] ${s()} awaiting workerReadyPromise (waiting for worker to post 'ready')...`);let k=n();await a(this,ae),console.info(`[PGliteInternal][worker-main] ${s()} workerReadyPromise resolved (waited ${(n()-k).toFixed(1)}ms, workerID=${a(this,Z)})`);let w=`pglite-tab-close:${a(this,v)}`;console.debug(`[PGliteInternal][worker-main] ${s()} acquiring tab close lock: ${w}`);let S=n();p(this,ie,await Ce(w)),console.debug(`[PGliteInternal][worker-main] ${s()} tab close lock acquired (took ${(n()-S).toFixed(1)}ms)`);let V=`pglite-broadcast:${a(this,Z)}`;p(this,_,new BroadcastChannel(V)),console.debug(`[PGliteInternal][worker-main] ${s()} broadcast channel created: ${V}`);let $=`pglite-tab:${a(this,v)}`;p(this,L,new BroadcastChannel($)),console.debug(`[PGliteInternal][worker-main] ${s()} tab channel created: ${$}`),a(this,_).addEventListener("message",async f=>{f.data.type==="leader-here"?(console.debug("[PGliteInternal][worker-main] received 'leader-here' on broadcast channel"),p(this,F,!1),a(this,R).dispatchEvent(new Event("leader-change")),l(this,h,fe).call(this)):f.data.type==="notify"&&l(this,h,Ye).call(this,f.data.channel,f.data.payload)}),a(this,L).addEventListener("message",async f=>{if(f.data.type==="connected")console.info(`[PGliteInternal][worker-main] ${s()} received 'connected' on tab channel - connection established!`),p(this,F,!0),a(this,R).dispatchEvent(new Event("connected")),p(this,J,await l(this,h,E).call(this,"getDebugLevel")),p(this,re,!0),console.info(`[PGliteInternal][worker-main] ${s()} ready flag set, debug level=${a(this,J)}`);else if(f.data.type==="connection-error"){console.error(`[PGliteInternal][worker-main] ${s()} \u274C CONNECTION FAILED: ${f.data.error?.message}`),console.error("[PGliteInternal][worker-main] Database health check failed - database may be corrupted"),console.error("[PGliteInternal][worker-main] \u{1F4A1} Recovery: Clear site data and reload");let oe=new CustomEvent("connection-error",{detail:{code:f.data.error?.code||"UNKNOWN",message:f.data.error?.message||"Connection failed"}});a(this,R).dispatchEvent(oe),a(this,R).dispatchEvent(new ErrorEvent("error",{message:f.data.error?.message||"Database connection failed",error:new Error(f.data.error?.message||"Database connection failed")}))}}),a(this,D).addEventListener("message",async f=>{f.data.type==="leader-now"&&(console.info(`[PGliteInternal][worker-main] ${s()} received 'leader-now' - this tab is the leader`),p(this,ne,!0),a(this,R).dispatchEvent(new Event("leader-change")))}),console.debug(`[PGliteInternal][worker-main] ${s()} starting leader notify loop`),l(this,h,fe).call(this),console.debug(`[PGliteInternal][worker-main] ${s()} initiating _initArrayTypes() (not awaited)`),this._initArrayTypes();let O=(n()-i).toFixed(1);console.info(`[PGliteInternal][worker-main] ${s()} ========== PGliteWorker #init COMPLETE (total ${O}ms) ==========`)},fe=async function(){a(this,F)||(a(this,_).postMessage({type:"tab-here",id:a(this,v)}),setTimeout(()=>l(this,h,fe).call(this),16))},E=async function(r,...n){let i=Me(),s={type:"rpc-call",callId:i,method:r,args:n};return a(this,L).postMessage(s),await new Promise((o,u)=>{let c=k=>{if(k.data.callId!==i)return;b();let w=k.data;if(w.type==="rpc-return")o(w.result);else if(w.type==="rpc-error"){let S=new Error(w.error.message);Object.assign(S,w.error),u(S)}else u(new Error("Invalid message"))},m=()=>{b(),u(new he)},b=()=>{a(this,L).removeEventListener("message",c),a(this,R).removeEventListener("leader-change",m)};a(this,R).addEventListener("leader-change",m),a(this,L).addEventListener("message",c)})},Ye=function(r,n){let i=a(this,M).get(r);if(i)for(let s of i)queueMicrotask(()=>s(n));for(let s of a(this,Q))queueMicrotask(()=>s(r,n))};var Le=Ge;async function Yt({init:e}){let t=()=>typeof performance<"u"&&performance.now?performance.now():Date.now(),r=t(),n=()=>`+${(t()-r).toFixed(1)}ms`;console.info(`[PGliteInternal][worker-thread] ${n()} ========== worker() START ==========`),console.debug(`[PGliteInternal][worker-thread] ${n()} posting 'here' message to main thread`),postMessage({type:"here"}),console.debug(`[PGliteInternal][worker-thread] ${n()} waiting for 'init' message from main thread...`);let i=t(),s=await new Promise(O=>{addEventListener("message",f=>{f.data.type==="init"&&O(f.data.options)},{once:!0})});console.info(`[PGliteInternal][worker-thread] ${n()} received 'init' message (waited ${(t()-i).toFixed(1)}ms, dataDir=${s.dataDir??"memory://"})`);let o=s.id??`${T}:${s.dataDir??""}`;console.debug(`[PGliteInternal][worker-thread] ${n()} worker id=${o}`),console.debug(`[PGliteInternal][worker-thread] ${n()} posting 'ready' message to main thread`),postMessage({type:"ready",id:o});let u=`pglite-election-lock:${o}`,c=`pglite-broadcast:${o}`,m=new BroadcastChannel(c),b=new Set;console.debug(`[PGliteInternal][worker-thread] ${n()} broadcast channel created: ${c}`),console.debug(`[PGliteInternal][worker-thread] ${n()} acquiring election lock: ${u}...`);let k=t();await Ce(u),console.info(`[PGliteInternal][worker-thread] ${n()} election lock acquired - THIS WORKER IS NOW LEADER (waited ${(t()-k).toFixed(1)}ms)`),console.debug(`[PGliteInternal][worker-thread] ${n()} calling init(options) to create PGlite instance...`);let w=t(),S=e(s);m.onmessage=async O=>{let f=O.data;switch(f.type){case"tab-here":console.debug(`[PGliteInternal][worker-thread] received 'tab-here' from tab ${f.id}`),Jt(f.id,await S,b);break}},console.debug(`[PGliteInternal][worker-thread] ${n()} posting 'leader-here' to broadcast channel`),m.postMessage({type:"leader-here",id:o}),console.debug(`[PGliteInternal][worker-thread] ${n()} posting 'leader-now' to main thread`),postMessage({type:"leader-now"}),console.debug(`[PGliteInternal][worker-thread] ${n()} awaiting dbPromise (PGlite initialization)...`);let V=await S;console.info(`[PGliteInternal][worker-thread] ${n()} dbPromise resolved - PGlite instance ready (took ${(t()-w).toFixed(1)}ms)`),V.onNotification((O,f)=>{m.postMessage({type:"notify",channel:O,payload:f})});let $=(t()-r).toFixed(1);console.info(`[PGliteInternal][worker-thread] ${n()} ========== worker() COMPLETE (total ${$}ms) ==========`)}var $e=!1;async function Jt(e,t,r){let n=()=>typeof performance<"u"&&performance.now?performance.now():Date.now();if(r.has(e)){console.debug(`[PGliteInternal][worker-thread] connectTab: tab ${e} already connected, skipping`);return}console.debug(`[PGliteInternal][worker-thread] connectTab: connecting tab ${e}`),r.add(e);let i=`pglite-tab:${e}`,s=`pglite-tab-close:${e}`,o=new BroadcastChannel(i);navigator.locks.request(s,()=>new Promise(m=>{console.debug(`[PGliteInternal][worker-thread] tab ${e} closed, cleaning up`),o.close(),r.delete(e),m()}));let u=Xt(e,t);o.addEventListener("message",async m=>{let b=m.data;switch(b.type){case"rpc-call":{let k=n(),{callId:w,method:S,args:V}=b;$e||console.info(`[PGliteInternal][worker-thread] FIRST RPC CALL: method=${S}, callId=${w}`),await t.waitReady;try{let $=await u[S](...V);o.postMessage({type:"rpc-return",callId:w,result:$}),$e||(console.info(`[PGliteInternal][worker-thread] FIRST RPC CALL COMPLETE: method=${S}, took ${(n()-k).toFixed(1)}ms`),$e=!0)}catch($){console.error($),o.postMessage({type:"rpc-error",callId:w,error:{message:$.message}})}break}}});let c=n();try{await t.waitReady,await t.query("SELECT 1 as health_check");let m=(n()-c).toFixed(1);console.debug(`[PGliteInternal][worker-thread] health check passed for tab ${e} (${m}ms)`),console.debug(`[PGliteInternal][worker-thread] posting 'connected' to tab ${e}`),o.postMessage({type:"connected"})}catch(m){console.error(`[PGliteInternal][worker-thread] \u274C Health check FAILED for tab ${e}:`,m),console.error(`[PGliteInternal][worker-thread] Database may be corrupted. Error: ${m.message}`),r.delete(e),o.postMessage({type:"connection-error",error:{message:`Database health check failed: ${m.message}`,code:"HEALTH_CHECK_FAILED"}}),o.close()}}function Xt(e,t){let r=null,n=null,i=`pglite-tab-close:${e}`;return Ce(i).then(()=>{n&&t.exec("ROLLBACK"),r?.(),n?.()}),{async getDebugLevel(){return t.debug},async close(){await t.close()},async execProtocol(s){let{messages:o,data:u}=await t.execProtocol(s);if(u.byteLength!==u.buffer.byteLength){let c=new ArrayBuffer(u.byteLength),m=new Uint8Array(c);return m.set(u),{messages:o,data:m}}else return{messages:o,data:u}},async execProtocolStream(s){return await t.execProtocolStream(s)},async execProtocolRaw(s){let o=await t.execProtocolRaw(s);if(o.byteLength!==o.buffer.byteLength){let u=new ArrayBuffer(o.byteLength),c=new Uint8Array(u);return c.set(o),c}else return o},async dumpDataDir(s){return await t.dumpDataDir(s)},async syncToFs(){return await t.syncToFs()},async _handleBlob(s){return await t._handleBlob(s)},async _getWrittenBlob(){return await t._getWrittenBlob()},async _cleanupBlob(){return await t._cleanupBlob()},async _checkReady(){return await t._checkReady()},async _acquireQueryLock(){return new Promise(s=>{t._runExclusiveQuery(()=>new Promise(o=>{r=o,s()}))})},async _releaseQueryLock(){r?.(),r=null},async _acquireTransactionLock(){return new Promise(s=>{t._runExclusiveTransaction(()=>new Promise(o=>{n=o,s()}))})},async _releaseTransactionLock(){n?.(),n=null}}}var he=class extends Error{constructor(){super("Leader changed, pending operation in indeterminate state")}};async function Ce(e){let t;return await new Promise(r=>{navigator.locks.request(e,()=>new Promise(n=>{t=n,r()}))}),t}0&&(module.exports={LeaderChangedError,PGliteWorker,worker});
//# sourceMappingURL=index.cjs.map