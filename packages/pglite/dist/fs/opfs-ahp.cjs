"use strict";var $e=Object.create;var K=Object.defineProperty;var We=Object.getOwnPropertyDescriptor;var qe=Object.getOwnPropertyNames;var Ye=Object.getPrototypeOf,Ve=Object.prototype.hasOwnProperty;var Se=e=>{throw TypeError(e)};var Xe=(e,t)=>()=>(e&&(t=e(e=0)),t);var H=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports),Ke=(e,t)=>{for(var r in t)K(e,r,{get:t[r],enumerable:!0})},be=(e,t,r,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let o of qe(t))!Ve.call(e,o)&&o!==r&&K(e,o,{get:()=>t[o],enumerable:!(n=We(t,o))||n.enumerable});return e};var ie=(e,t,r)=>(r=e!=null?$e(Ye(e)):{},be(t||!e||!e.__esModule?K(r,"default",{value:e,enumerable:!0}):r,e)),Je=e=>be(K({},"__esModule",{value:!0}),e);var oe=(e,t,r)=>t.has(e)||Se("Cannot "+r);var l=(e,t,r)=>(oe(e,t,"read from private field"),r?r.call(e):t.get(e)),P=(e,t,r)=>t.has(e)?Se("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(e):t.set(e,r),U=(e,t,r,n)=>(oe(e,t,"write to private field"),n?n.call(e,r):t.set(e,r),r),p=(e,t,r)=>(oe(e,t,"access private method"),r);var se=(e,t,r,n)=>({set _(o){U(e,t,o,r)},get _(){return l(e,t,n)}});var g=Xe(()=>{"use strict"});var G=H((zt,F)=>{"use strict";g();var we=9007199254740991,Fe=(function(e){return e})();function Ze(e){return e===Fe}function Ae(e){return typeof e=="string"||Object.prototype.toString.call(e)=="[object String]"}function Qe(e){return Object.prototype.toString.call(e)=="[object Date]"}function J(e){return e!==null&&typeof e=="object"}function Z(e){return typeof e=="function"}function et(e){return typeof e=="number"&&e>-1&&e%1==0&&e<=we}function tt(e){return Object.prototype.toString.call(e)=="[object Array]"}function Pe(e){return J(e)&&!Z(e)&&et(e.length)}function ae(e){return Object.prototype.toString.call(e)=="[object ArrayBuffer]"}function rt(e,t){return Array.prototype.map.call(e,t)}function nt(e,t){var r=Fe;return Z(t)&&Array.prototype.every.call(e,function(n,o,i){var s=t(n,o,i);return s&&(r=n),!s}),r}function it(e){return Object.assign.apply(null,arguments)}function Ne(e){var t,r,n;if(Ae(e)){for(r=e.length,n=new Uint8Array(r),t=0;t<r;t++)n[t]=e.charCodeAt(t)&255;return n}return ae(e)?new Uint8Array(e):J(e)&&ae(e.buffer)?new Uint8Array(e.buffer):Pe(e)?new Uint8Array(e):J(e)&&Z(e.toString)?Ne(e.toString()):new Uint8Array}F.exports.MAX_SAFE_INTEGER=we;F.exports.isUndefined=Ze;F.exports.isString=Ae;F.exports.isObject=J;F.exports.isDateTime=Qe;F.exports.isFunction=Z;F.exports.isArray=tt;F.exports.isArrayLike=Pe;F.exports.isArrayBuffer=ae;F.exports.map=rt;F.exports.find=nt;F.exports.extend=it;F.exports.toUint8Array=Ne});var $=H((Ht,Ee)=>{"use strict";g();var ce="\0";Ee.exports={NULL_CHAR:ce,TMAGIC:"ustar"+ce+"00",OLDGNU_MAGIC:"ustar  "+ce,REGTYPE:0,LNKTYPE:1,SYMTYPE:2,CHRTYPE:3,BLKTYPE:4,DIRTYPE:5,FIFOTYPE:6,CONTTYPE:7,TSUID:parseInt("4000",8),TSGID:parseInt("2000",8),TSVTX:parseInt("1000",8),TUREAD:parseInt("0400",8),TUWRITE:parseInt("0200",8),TUEXEC:parseInt("0100",8),TGREAD:parseInt("0040",8),TGWRITE:parseInt("0020",8),TGEXEC:parseInt("0010",8),TOREAD:parseInt("0004",8),TOWRITE:parseInt("0002",8),TOEXEC:parseInt("0001",8),TPERMALL:parseInt("0777",8),TPERMMASK:parseInt("0777",8)}});var ue=H((jt,A)=>{"use strict";g();var Te=G(),b=$(),ot=512,le=b.TPERMALL,Oe=0,De=0,de=[["name",100,0,function(e,t){return W(e[t[0]],t[1])},function(e,t,r){return M(e.slice(t,t+r[1]))}],["mode",8,100,function(e,t){var r=e[t[0]]||le;return r=r&b.TPERMMASK,L(r,t[1],le)},function(e,t,r){var n=D(e.slice(t,t+r[1]));return n&=b.TPERMMASK,n}],["uid",8,108,function(e,t){return L(e[t[0]],t[1],Oe)},function(e,t,r){return D(e.slice(t,t+r[1]))}],["gid",8,116,function(e,t){return L(e[t[0]],t[1],De)},function(e,t,r){return D(e.slice(t,t+r[1]))}],["size",12,124,function(e,t){return L(e.data.length,t[1])},function(e,t,r){return D(e.slice(t,t+r[1]))}],["modifyTime",12,136,function(e,t){return Q(e[t[0]],t[1])},function(e,t,r){return ee(e.slice(t,t+r[1]))}],["checksum",8,148,function(e,t){return"        "},function(e,t,r){return D(e.slice(t,t+r[1]))}],["type",1,156,function(e,t){return""+(parseInt(e[t[0]],10)||0)%8},function(e,t,r){return(parseInt(String.fromCharCode(e[t]),10)||0)%8}],["linkName",100,157,function(e,t){return""},function(e,t,r){return M(e.slice(t,t+r[1]))}],["ustar",8,257,function(e,t){return b.TMAGIC},function(e,t,r){return st(M(e.slice(t,t+r[1]),!0))},function(e,t){return e[t[0]]==b.TMAGIC||e[t[0]]==b.OLDGNU_MAGIC}],["owner",32,265,function(e,t){return W(e[t[0]],t[1])},function(e,t,r){return M(e.slice(t,t+r[1]))}],["group",32,297,function(e,t){return W(e[t[0]],t[1])},function(e,t,r){return M(e.slice(t,t+r[1]))}],["majorNumber",8,329,function(e,t){return""},function(e,t,r){return D(e.slice(t,t+r[1]))}],["minorNumber",8,337,function(e,t){return""},function(e,t,r){return D(e.slice(t,t+r[1]))}],["prefix",131,345,function(e,t){return W(e[t[0]],t[1])},function(e,t,r){return M(e.slice(t,t+r[1]))}],["accessTime",12,476,function(e,t){return Q(e[t[0]],t[1])},function(e,t,r){return ee(e.slice(t,t+r[1]))}],["createTime",12,488,function(e,t){return Q(e[t[0]],t[1])},function(e,t,r){return ee(e.slice(t,t+r[1]))}]],ve=(function(e){var t=e[e.length-1];return t[2]+t[1]})(de);function st(e){if(e.length==8){var t=e.split("");if(t[5]==b.NULL_CHAR)return(t[6]==" "||t[6]==b.NULL_CHAR)&&(t[6]="0"),(t[7]==" "||t[7]==b.NULL_CHAR)&&(t[7]="0"),t=t.join(""),t==b.TMAGIC?t:e;if(t[7]==b.NULL_CHAR)return t[5]==b.NULL_CHAR&&(t[5]=" "),t[6]==b.NULL_CHAR&&(t[6]=" "),t==b.OLDGNU_MAGIC?t:e}return e}function W(e,t){return t-=1,Te.isUndefined(e)&&(e=""),e=(""+e).substr(0,t),e+b.NULL_CHAR}function L(e,t,r){for(r=parseInt(r)||0,t-=1,e=(parseInt(e)||r).toString(8).substr(-t,t);e.length<t;)e="0"+e;return e+b.NULL_CHAR}function Q(e,t){if(Te.isDateTime(e))e=Math.floor(1*e/1e3);else if(e=parseInt(e,10),isFinite(e)){if(e<=0)return""}else e=Math.floor(1*new Date/1e3);return L(e,t,0)}function M(e,t){var r=String.fromCharCode.apply(null,e);if(t)return r;var n=r.indexOf(b.NULL_CHAR);return n>=0?r.substr(0,n):r}function D(e){var t=String.fromCharCode.apply(null,e);return parseInt(t.replace(/^0+$/g,""),8)||0}function ee(e){return e.length==0||e[0]==0?null:new Date(1e3*D(e))}function at(e,t,r){var n=parseInt(t,10)||0,o=Math.min(n+ve,e.length),i=0,s=0,a=0;r&&de.every(function(h){return h[0]=="checksum"?(s=n+h[2],a=s+h[1],!1):!0});for(var c=32,d=n;d<o;d++){var m=d>=s&&d<a?c:e[d];i=(i+m)%262144}return i}A.exports.recordSize=ot;A.exports.defaultFileMode=le;A.exports.defaultUid=Oe;A.exports.defaultGid=De;A.exports.posixHeader=de;A.exports.effectiveHeaderSize=ve;A.exports.calculateChecksum=at;A.exports.formatTarString=W;A.exports.formatTarNumber=L;A.exports.formatTarDateTime=Q;A.exports.parseTarString=M;A.exports.parseTarNumber=D;A.exports.parseTarDateTime=ee});var Ie=H((Gt,_e)=>{"use strict";g();var ct=$(),te=G(),I=ue();function xe(e){return I.recordSize}function ke(e){return Math.ceil(e.data.length/I.recordSize)*I.recordSize}function lt(e){var t=0;return e.forEach(function(r){t+=xe(r)+ke(r)}),t+=I.recordSize*2,new Uint8Array(t)}function dt(e,t,r){r=parseInt(r)||0;var n=r;I.posixHeader.forEach(function(c){for(var d=c[3](t,c),m=d.length,h=0;h<m;h+=1)e[n+h]=d.charCodeAt(h)&255;n+=c[1]});var o=te.find(I.posixHeader,function(c){return c[0]=="checksum"});if(o){var i=I.calculateChecksum(e,r,!0),s=I.formatTarNumber(i,o[1]-2)+ct.NULL_CHAR+" ";n=r+o[2];for(var a=0;a<s.length;a+=1)e[n]=s.charCodeAt(a)&255,n++}return r+xe(t)}function ut(e,t,r){return r=parseInt(r,10)||0,e.set(t.data,r),r+ke(t)}function pt(e){e=te.map(e,function(n){return te.extend({},n,{data:te.toUint8Array(n.data)})});var t=lt(e),r=0;return e.forEach(function(n){r=dt(t,n,r),r=ut(t,n,r)}),t}_e.exports.tar=pt});var Ue=H((Wt,Ce)=>{"use strict";g();var mt=$(),me=G(),E=ue(),ht={extractData:!0,checkHeader:!0,checkChecksum:!0,checkFileSize:!0},ft={size:!0,checksum:!0,ustar:!0},pe={unexpectedEndOfFile:"Unexpected end of file.",fileCorrupted:"File is corrupted.",checksumCheckFailed:"Checksum check failed."};function yt(e){return E.recordSize}function gt(e){return Math.ceil(e/E.recordSize)*E.recordSize}function St(e,t){for(var r=t,n=Math.min(e.length,t+E.recordSize*2),o=r;o<n;o++)if(e[o]!=0)return!1;return!0}function bt(e,t,r){if(e.length-t<E.recordSize){if(r.checkFileSize)throw new Error(pe.unexpectedEndOfFile);return null}t=parseInt(t)||0;var n={},o=t;if(E.posixHeader.forEach(function(a){n[a[0]]=a[4](e,o,a),o+=a[1]}),n.type!=0&&(n.size=0),r.checkHeader&&E.posixHeader.forEach(function(a){if(me.isFunction(a[5])&&!a[5](n,a)){var c=new Error(pe.fileCorrupted);throw c.data={offset:t+a[2],field:a[0]},c}}),r.checkChecksum){var i=E.calculateChecksum(e,t,!0);if(i!=n.checksum){var s=new Error(pe.checksumCheckFailed);throw s.data={offset:t,header:n,checksum:i},s}}return n}function wt(e,t,r,n){return n.extractData?r.size<=0?new Uint8Array:e.slice(t,t+r.size):null}function Ft(e,t){var r={};return E.posixHeader.forEach(function(n){var o=n[0];ft[o]||(r[o]=e[o])}),r.isOldGNUFormat=e.ustar==mt.OLDGNU_MAGIC,t&&(r.data=t),r}function At(e,t){t=me.extend({},ht,t);for(var r=[],n=0,o=e.length;o-n>=E.recordSize;){e=me.toUint8Array(e);var i=bt(e,n,t);if(!i)break;n+=yt(i);var s=wt(e,n,i,t);if(r.push(Ft(i,s)),n+=gt(i.size),St(e,n))break}return r}Ce.exports.untar=At});var ze=H((Yt,Me)=>{"use strict";g();var Pt=G(),Nt=$(),Et=Ie(),Tt=Ue();Pt.extend(Me.exports,Et,Tt,Nt)});var Ct={};Ke(Ct,{OpfsAhpFS:()=>ye});module.exports=Je(Ct);g();g();g();var z=ie(ze(),1);async function Re(e,t,r="pgdata",n="auto"){let o=Dt(e,t),[i,s]=await vt(o,n),a=r+(s?".tar.gz":".tar"),c=s?"application/x-gzip":"application/x-tar";return typeof File<"u"?new File([i],a,{type:c}):new Blob([i],{type:c})}function Ot(e,t){let r=[],n=o=>{e.readdir(o).forEach(s=>{if(s==="."||s==="..")return;let a=o+"/"+s,c=e.stat(a),d=e.isFile(c.mode)?e.readFile(a,{encoding:"binary"}):new Uint8Array(0);r.push({name:a.substring(t.length),mode:c.mode,size:c.size,type:e.isFile(c.mode)?z.REGTYPE:z.DIRTYPE,modifyTime:c.mtime,data:d}),e.isDir(c.mode)&&n(a)})};return n(t),r}function Dt(e,t){let r=Ot(e,t);return(0,z.tar)(r)}async function vt(e,t="auto"){if(t==="none")return[e,!1];if(typeof CompressionStream<"u")return[await xt(e),!0];if(typeof process<"u"&&process.versions&&process.versions.node)return[await kt(e),!0];if(t==="auto")return[e,!1];throw new Error("Compression not supported in this environment")}async function xt(e){let t=new CompressionStream("gzip"),r=t.writable.getWriter(),n=t.readable.getReader();r.write(e),r.close();let o=[];for(;;){let{value:a,done:c}=await n.read();if(c)break;a&&o.push(a)}let i=new Uint8Array(o.reduce((a,c)=>a+c.length,0)),s=0;return o.forEach(a=>{i.set(a,s),s+=a.length}),i}async function kt(e){let{promisify:t}=await import("util"),{gzip:r}=await import("zlib");return await t(r)(e)}var _t="/tmp/pglite",he=_t+"/base";var re=class{constructor(t,{debug:r=!1}={}){this.dataDir=t,this.debug=r}async syncToFs(t){}async initialSyncFs(){}async closeFs(){}async dumpTar(t,r){return Re(this.pg.Module.FS,he,t,r)}async init(t,r){return this.pg=t,{emscriptenOpts:{...r,preRun:[...r.preRun||[],o=>{let i=It(o,this);o.FS.mkdir(he),o.FS.mount(i,{},he)}]}}}},ne={EBADF:8,EBADFD:127,EEXIST:20,EINVAL:28,EISDIR:31,ENODEV:43,ENOENT:44,ENOTDIR:54,ENOTEMPTY:55},It=(e,t)=>{let r=e.FS,n=t.debug?console.log:null,o={tryFSOperation(i){try{return i()}catch(s){throw s.code?s.code==="UNKNOWN"?new r.ErrnoError(ne.EINVAL):new r.ErrnoError(s.code):s}},mount(i){return o.createNode(null,"/",16895,0)},syncfs(i,s,a){},createNode(i,s,a,c){if(!r.isDir(a)&&!r.isFile(a))throw new r.ErrnoError(28);let d=r.createNode(i,s,a);return d.node_ops=o.node_ops,d.stream_ops=o.stream_ops,d},getMode:function(i){return n?.("getMode",i),o.tryFSOperation(()=>t.lstat(i).mode)},realPath:function(i){let s=[];for(;i.parent!==i;)s.push(i.name),i=i.parent;return s.push(i.mount.opts.root),s.reverse(),s.join("/")},node_ops:{getattr(i){n?.("getattr",o.realPath(i));let s=o.realPath(i);return o.tryFSOperation(()=>{let a=t.lstat(s);return{...a,dev:0,ino:i.id,nlink:1,rdev:i.rdev,atime:new Date(a.atime),mtime:new Date(a.mtime),ctime:new Date(a.ctime)}})},setattr(i,s){n?.("setattr",o.realPath(i),s);let a=o.realPath(i);o.tryFSOperation(()=>{s.mode!==void 0&&t.chmod(a,s.mode),s.size!==void 0&&t.truncate(a,s.size),s.timestamp!==void 0&&t.utimes(a,s.timestamp,s.timestamp),s.size!==void 0&&t.truncate(a,s.size)})},lookup(i,s){n?.("lookup",o.realPath(i),s);let a=[o.realPath(i),s].join("/"),c=o.getMode(a);return o.createNode(i,s,c)},mknod(i,s,a,c){n?.("mknod",o.realPath(i),s,a,c);let d=o.createNode(i,s,a,c),m=o.realPath(d);return o.tryFSOperation(()=>(r.isDir(d.mode)?t.mkdir(m,{mode:a}):t.writeFile(m,"",{mode:a}),d))},rename(i,s,a){n?.("rename",o.realPath(i),o.realPath(s),a);let c=o.realPath(i),d=[o.realPath(s),a].join("/");o.tryFSOperation(()=>{t.rename(c,d)}),i.name=a},unlink(i,s){n?.("unlink",o.realPath(i),s);let a=[o.realPath(i),s].join("/");try{t.unlink(a)}catch{}},rmdir(i,s){n?.("rmdir",o.realPath(i),s);let a=[o.realPath(i),s].join("/");return o.tryFSOperation(()=>{t.rmdir(a)})},readdir(i){n?.("readdir",o.realPath(i));let s=o.realPath(i);return o.tryFSOperation(()=>t.readdir(s))},symlink(i,s,a){throw n?.("symlink",o.realPath(i),s,a),new r.ErrnoError(63)},readlink(i){throw n?.("readlink",o.realPath(i)),new r.ErrnoError(63)}},stream_ops:{open(i){n?.("open stream",o.realPath(i.node));let s=o.realPath(i.node);return o.tryFSOperation(()=>{r.isFile(i.node.mode)&&(i.shared.refcount=1,i.nfd=t.open(s))})},close(i){return n?.("close stream",o.realPath(i.node)),o.tryFSOperation(()=>{r.isFile(i.node.mode)&&i.nfd&&--i.shared.refcount===0&&t.close(i.nfd)})},dup(i){n?.("dup stream",o.realPath(i.node)),i.shared.refcount++},read(i,s,a,c,d){return n?.("read stream",o.realPath(i.node),a,c,d),c===0?0:o.tryFSOperation(()=>t.read(i.nfd,s,a,c,d))},write(i,s,a,c,d){return n?.("write stream",o.realPath(i.node),a,c,d),o.tryFSOperation(()=>t.write(i.nfd,s.buffer,a,c,d))},llseek(i,s,a){n?.("llseek stream",o.realPath(i.node),s,a);let c=s;if(a===1?c+=i.position:a===2&&r.isFile(i.node.mode)&&o.tryFSOperation(()=>{let d=t.fstat(i.nfd);c+=d.size}),c<0)throw new r.ErrnoError(28);return c},mmap(i,s,a,c,d){if(n?.("mmap stream",o.realPath(i.node),s,a,c,d),!r.isFile(i.node.mode))throw new r.ErrnoError(ne.ENODEV);let m=e.mmapAlloc(s);return o.stream_ops.read(i,e.HEAP8,m,s,a),{ptr:m,allocated:!0}},msync(i,s,a,c,d){return n?.("msync stream",o.realPath(i.node),a,c,d),o.stream_ops.write(i,s,0,c,a),0}}};return o};var He="state.txt",Le="data",fe={DIR:16384,FILE:32768},Y,B,C,V,y,O,S,X,v,x,N,u,je,R,j,T,w,q,Be,ge,ye=class extends re{constructor(r,{initialPoolSize:n=1e3,maintainedPoolSize:o=100,debug:i=!1}={}){super(r,{debug:i});P(this,u);P(this,Y);P(this,B);P(this,C);P(this,V);P(this,y);P(this,O,new Map);P(this,S,new Map);P(this,X,0);P(this,v,new Map);P(this,x,new Map);this.lastCheckpoint=0;this.checkpointInterval=1e3*5;this.poolCounter=0;P(this,N,new Set);this.initialPoolSize=n,this.maintainedPoolSize=o}async init(r,n){return await p(this,u,je).call(this),super.init(r,n)}async syncToFs(r=!1){await this.maybeCheckpointState(),await this.maintainPool(),r||this.flush()}async closeFs(){for(let r of l(this,S).values())r.close();l(this,y).flush(),l(this,y).close(),this.pg.Module.FS.quit()}async emergencyCloseAllHandles(){console.info("[OpfsAhpFS] emergencyCloseAllHandles: starting emergency cleanup...");let r=0,n=0;for(let[o,i]of l(this,S).entries())try{i.close(),r++,console.debug(`[OpfsAhpFS] emergencyCloseAllHandles: closed handle for ${o}`)}catch(s){console.warn(`[OpfsAhpFS] emergencyCloseAllHandles: error closing handle for ${o}:`,s),n++}l(this,S).clear(),l(this,O).clear(),l(this,v).clear(),l(this,x).clear();for(let o of l(this,N))try{o.close(),r++}catch(i){console.warn("[OpfsAhpFS] emergencyCloseAllHandles: error closing unsynced handle:",i),n++}if(l(this,N).clear(),l(this,y))try{l(this,y).flush(),l(this,y).close(),console.debug("[OpfsAhpFS] emergencyCloseAllHandles: closed state handle"),r++}catch(o){console.warn("[OpfsAhpFS] emergencyCloseAllHandles: error closing state handle:",o),n++}console.info(`[OpfsAhpFS] emergencyCloseAllHandles: complete (closed=${r}, errors=${n})`)}async maintainPool(r){r=r||this.maintainedPoolSize;let n=r-this.state.pool.length,o=[];for(let i=0;i<n;i++)o.push(new Promise(async s=>{++this.poolCounter;let a=`${(Date.now()-1704063600).toString(16).padStart(8,"0")}-${this.poolCounter.toString(16).padStart(8,"0")}`,c=await l(this,C).getFileHandle(a,{create:!0}),d=await c.createSyncAccessHandle();l(this,O).set(a,c),l(this,S).set(a,d),p(this,u,j).call(this,{opp:"createPoolFile",args:[a]}),this.state.pool.push(a),s()}));for(let i=0;i>n;i--)o.push(new Promise(async s=>{let a=this.state.pool.pop();p(this,u,j).call(this,{opp:"deletePoolFile",args:[a]});let c=l(this,O).get(a);l(this,S).get(a)?.close(),await l(this,C).removeEntry(c.name),l(this,O).delete(a),l(this,S).delete(a),s()}));await Promise.all(o)}_createPoolFileState(r){this.state.pool.push(r)}_deletePoolFileState(r){let n=this.state.pool.indexOf(r);n>-1&&this.state.pool.splice(n,1)}async maybeCheckpointState(){Date.now()-this.lastCheckpoint>this.checkpointInterval&&await this.checkpointState()}async checkpointState(){let r=new TextEncoder().encode(JSON.stringify(this.state));l(this,y).truncate(0),l(this,y).write(r,{at:0}),l(this,y).flush(),this.lastCheckpoint=Date.now()}flush(){for(let r of l(this,N))try{r.flush()}catch{}l(this,N).clear()}chmod(r,n){p(this,u,R).call(this,{opp:"chmod",args:[r,n]},()=>{this._chmodState(r,n)})}_chmodState(r,n){let o=p(this,u,w).call(this,r);o.mode=n}close(r){let n=p(this,u,q).call(this,r);l(this,v).delete(r),l(this,x).delete(n)}fstat(r){let n=p(this,u,q).call(this,r);return this.lstat(n)}lstat(r){let n=p(this,u,w).call(this,r),o=n.type==="file"?l(this,S).get(n.backingFilename).getSize():0,i=4096;return{dev:0,ino:0,mode:n.mode,nlink:1,uid:0,gid:0,rdev:0,size:o,blksize:i,blocks:Math.ceil(o/i),atime:n.lastModified,mtime:n.lastModified,ctime:n.lastModified}}mkdir(r,n){p(this,u,R).call(this,{opp:"mkdir",args:[r,n]},()=>{this._mkdirState(r,n)})}_mkdirState(r,n){let o=p(this,u,T).call(this,r),i=o.pop(),s=[],a=this.state.root;for(let d of o){if(s.push(r),!Object.prototype.hasOwnProperty.call(a.children,d))if(n?.recursive)this.mkdir(s.join("/"));else throw new f("ENOENT","No such file or directory");if(a.children[d].type!=="directory")throw new f("ENOTDIR","Not a directory");a=a.children[d]}if(Object.prototype.hasOwnProperty.call(a.children,i))throw new f("EEXIST","File exists");let c={type:"directory",lastModified:Date.now(),mode:n?.mode||fe.DIR,children:{}};a.children[i]=c}open(r,n,o){if(p(this,u,w).call(this,r).type!=="file")throw new f("EISDIR","Is a directory");let s=p(this,u,Be).call(this);return l(this,v).set(s,r),l(this,x).set(r,s),s}readdir(r){let n=p(this,u,w).call(this,r);if(n.type!=="directory")throw new f("ENOTDIR","Not a directory");return Object.keys(n.children)}read(r,n,o,i,s){let a=p(this,u,q).call(this,r),c=p(this,u,w).call(this,a);if(c.type!=="file")throw new f("EISDIR","Is a directory");return l(this,S).get(c.backingFilename).read(new Uint8Array(n.buffer,o,i),{at:s})}rename(r,n){p(this,u,R).call(this,{opp:"rename",args:[r,n]},()=>{this._renameState(r,n,!0)})}_renameState(r,n,o=!1){let i=p(this,u,T).call(this,r),s=i.pop(),a=p(this,u,w).call(this,i.join("/"));if(!Object.prototype.hasOwnProperty.call(a.children,s))throw new f("ENOENT","No such file or directory");let c=p(this,u,T).call(this,n),d=c.pop(),m=p(this,u,w).call(this,c.join("/"));if(o&&Object.prototype.hasOwnProperty.call(m.children,d)){let h=m.children[d];l(this,S).get(h.backingFilename).truncate(0),this.state.pool.push(h.backingFilename)}m.children[d]=a.children[s],delete a.children[s]}rmdir(r){p(this,u,R).call(this,{opp:"rmdir",args:[r]},()=>{this._rmdirState(r)})}_rmdirState(r){let n=p(this,u,T).call(this,r),o=n.pop(),i=p(this,u,w).call(this,n.join("/"));if(!Object.prototype.hasOwnProperty.call(i.children,o))throw new f("ENOENT","No such file or directory");let s=i.children[o];if(s.type!=="directory")throw new f("ENOTDIR","Not a directory");if(Object.keys(s.children).length>0)throw new f("ENOTEMPTY","Directory not empty");delete i.children[o]}truncate(r,n=0){let o=p(this,u,w).call(this,r);if(o.type!=="file")throw new f("EISDIR","Is a directory");let i=l(this,S).get(o.backingFilename);if(!i)throw new f("ENOENT","No such file or directory");i.truncate(n),l(this,N).add(i)}unlink(r){p(this,u,R).call(this,{opp:"unlink",args:[r]},()=>{this._unlinkState(r,!0)})}_unlinkState(r,n=!1){let o=p(this,u,T).call(this,r),i=o.pop(),s=p(this,u,w).call(this,o.join("/"));if(!Object.prototype.hasOwnProperty.call(s.children,i))throw new f("ENOENT","No such file or directory");let a=s.children[i];if(a.type!=="file")throw new f("EISDIR","Is a directory");if(delete s.children[i],n){let c=l(this,S).get(a.backingFilename);c?.truncate(0),l(this,N).add(c),l(this,x).has(r)&&(l(this,v).delete(l(this,x).get(r)),l(this,x).delete(r))}this.state.pool.push(a.backingFilename)}utimes(r,n,o){p(this,u,R).call(this,{opp:"utimes",args:[r,n,o]},()=>{this._utimesState(r,n,o)})}_utimesState(r,n,o){let i=p(this,u,w).call(this,r);i.lastModified=o}writeFile(r,n,o){let i=p(this,u,T).call(this,r),s=i.pop(),a=p(this,u,w).call(this,i.join("/"));if(Object.prototype.hasOwnProperty.call(a.children,s)){let m=a.children[s];m.lastModified=Date.now(),p(this,u,j).call(this,{opp:"setLastModified",args:[r,m.lastModified]})}else{if(this.state.pool.length===0)throw new Error("No more file handles available in the pool");let m={type:"file",lastModified:Date.now(),mode:o?.mode||fe.FILE,backingFilename:this.state.pool.pop()};a.children[s]=m,p(this,u,j).call(this,{opp:"createFileNode",args:[r,m]})}let c=a.children[s],d=l(this,S).get(c.backingFilename);n.length>0&&(d.write(typeof n=="string"?new TextEncoder().encode(n):new Uint8Array(n),{at:0}),r.startsWith("/pg_wal")&&l(this,N).add(d))}_createFileNodeState(r,n){let o=p(this,u,T).call(this,r),i=o.pop(),s=p(this,u,w).call(this,o.join("/"));s.children[i]=n;let a=this.state.pool.indexOf(n.backingFilename);return a>-1&&this.state.pool.splice(a,1),n}_setLastModifiedState(r,n){let o=p(this,u,w).call(this,r);o.lastModified=n}write(r,n,o,i,s){let a=p(this,u,q).call(this,r),c=p(this,u,w).call(this,a);if(c.type!=="file")throw new f("EISDIR","Is a directory");let d=l(this,S).get(c.backingFilename);if(!d)throw new f("EBADF","Bad file descriptor");let m=d.write(new Uint8Array(n,o,i),{at:s});return a.startsWith("/pg_wal")&&l(this,N).add(d),m}};Y=new WeakMap,B=new WeakMap,C=new WeakMap,V=new WeakMap,y=new WeakMap,O=new WeakMap,S=new WeakMap,X=new WeakMap,v=new WeakMap,x=new WeakMap,N=new WeakMap,u=new WeakSet,je=async function(){console.info(`[OpfsAhpFS] #init: starting OPFS-AHP initialization for dataDir=${this.dataDir}`),U(this,Y,await navigator.storage.getDirectory()),console.debug("[OpfsAhpFS] #init: got OPFS root directory handle"),U(this,B,await p(this,u,ge).call(this,this.dataDir,{create:!0})),console.debug(`[OpfsAhpFS] #init: resolved root directory handle for ${this.dataDir}`),U(this,C,await p(this,u,ge).call(this,Le,{from:l(this,B),create:!0})),console.debug(`[OpfsAhpFS] #init: resolved data directory handle for ${Le}`),U(this,V,await l(this,B).getFileHandle(He,{create:!0})),console.debug(`[OpfsAhpFS] #init: got file handle for ${He}`),console.info("[OpfsAhpFS] #init: creating state sync access handle (exclusive lock)..."),U(this,y,await l(this,V).createSyncAccessHandle()),console.info("[OpfsAhpFS] #init: state sync access handle created successfully");let r=new ArrayBuffer(l(this,y).getSize());l(this,y).read(r,{at:0});let n,o=new TextDecoder().decode(r).split(`
`),i=!1;try{n=JSON.parse(o[0])}catch{n={root:{type:"directory",lastModified:Date.now(),mode:fe.DIR,children:{}},pool:[]},l(this,y).truncate(0),l(this,y).write(new TextEncoder().encode(JSON.stringify(n)),{at:0}),i=!0}this.state=n;let s=o.slice(1).filter(Boolean).map(m=>JSON.parse(m));for(let m of s){let h=`_${m.opp}State`;if(typeof this[h]=="function")try{this[h].bind(this)(...m.args)}catch(k){console.warn("Error applying OPFS AHP WAL entry",m,k)}}let a=[],c=async m=>{if(m.type==="file")try{let h=await l(this,C).getFileHandle(m.backingFilename),k=await h.createSyncAccessHandle();l(this,O).set(m.backingFilename,h),l(this,S).set(m.backingFilename,k)}catch(h){console.error("Error opening file handle for node",m,h)}else for(let h of Object.values(m.children))a.push(c(h))};await c(this.state.root);let d=[];for(let m of this.state.pool)d.push(new Promise(async h=>{l(this,O).has(m)&&console.warn("File handle already exists for pool file",m);let k=await l(this,C).getFileHandle(m),Ge=await k.createSyncAccessHandle();l(this,O).set(m,k),l(this,S).set(m,Ge),h()}));await Promise.all([...a,...d]),await this.maintainPool(i?this.initialPoolSize:this.maintainedPoolSize)},R=function(r,n){let o=p(this,u,j).call(this,r);try{n()}catch(i){throw l(this,y).truncate(o),i}},j=function(r){let n=JSON.stringify(r),o=new TextEncoder().encode(`
${n}`),i=l(this,y).getSize();return l(this,y).write(o,{at:i}),l(this,N).add(l(this,y)),i},T=function(r){return r.split("/").filter(Boolean)},w=function(r,n){let o=p(this,u,T).call(this,r),i=n||this.state.root;for(let s of o){if(i.type!=="directory")throw new f("ENOTDIR","Not a directory");if(!Object.prototype.hasOwnProperty.call(i.children,s))throw new f("ENOENT","No such file or directory");i=i.children[s]}return i},q=function(r){let n=l(this,v).get(r);if(!n)throw new f("EBADF","Bad file descriptor");return n},Be=function(){let r=++se(this,X)._;for(;l(this,v).has(r);)se(this,X)._++;return r},ge=async function(r,n){let o=p(this,u,T).call(this,r),i=n?.from||l(this,Y);for(let s of o)i=await i.getDirectoryHandle(s,{create:n?.create});return i};var f=class extends Error{constructor(t,r){super(r),typeof t=="number"?this.code=t:typeof t=="string"&&(this.code=ne[t])}};0&&(module.exports={OpfsAhpFS});
//# sourceMappingURL=opfs-ahp.cjs.map