import{a as N,c as gr,j as d}from"./chunk-LXLR7NCL.js";var _=N((te,g)=>{"use strict";d();var W=9007199254740991,Y=(function(r){return r})();function yr(r){return r===Y}function V(r){return typeof r=="string"||Object.prototype.toString.call(r)=="[object String]"}function hr(r){return Object.prototype.toString.call(r)=="[object Date]"}function C(r){return r!==null&&typeof r=="object"}function D(r){return typeof r=="function"}function Sr(r){return typeof r=="number"&&r>-1&&r%1==0&&r<=W}function br(r){return Object.prototype.toString.call(r)=="[object Array]"}function X(r){return C(r)&&!D(r)&&Sr(r.length)}function R(r){return Object.prototype.toString.call(r)=="[object ArrayBuffer]"}function Fr(r,e){return Array.prototype.map.call(r,e)}function Tr(r,e){var t=Y;return D(e)&&Array.prototype.every.call(r,function(s,o,n){var i=e(s,o,n);return i&&(t=s),!i}),t}function Er(r){return Object.assign.apply(null,arguments)}function K(r){var e,t,s;if(V(r)){for(t=r.length,s=new Uint8Array(t),e=0;e<t;e++)s[e]=r.charCodeAt(e)&255;return s}return R(r)?new Uint8Array(r):C(r)&&R(r.buffer)?new Uint8Array(r.buffer):X(r)?new Uint8Array(r):C(r)&&D(r.toString)?K(r.toString()):new Uint8Array}g.exports.MAX_SAFE_INTEGER=W;g.exports.isUndefined=yr;g.exports.isString=V;g.exports.isObject=C;g.exports.isDateTime=hr;g.exports.isFunction=D;g.exports.isArray=br;g.exports.isArrayLike=X;g.exports.isArrayBuffer=R;g.exports.map=Fr;g.exports.find=Tr;g.exports.extend=Er;g.exports.toUint8Array=K});var v=N((ie,Z)=>{"use strict";d();var L="\0";Z.exports={NULL_CHAR:L,TMAGIC:"ustar"+L+"00",OLDGNU_MAGIC:"ustar  "+L,REGTYPE:0,LNKTYPE:1,SYMTYPE:2,CHRTYPE:3,BLKTYPE:4,DIRTYPE:5,FIFOTYPE:6,CONTTYPE:7,TSUID:parseInt("4000",8),TSGID:parseInt("2000",8),TSVTX:parseInt("1000",8),TUREAD:parseInt("0400",8),TUWRITE:parseInt("0200",8),TUEXEC:parseInt("0100",8),TGREAD:parseInt("0040",8),TGWRITE:parseInt("0020",8),TGEXEC:parseInt("0010",8),TOREAD:parseInt("0004",8),TOWRITE:parseInt("0002",8),TOEXEC:parseInt("0001",8),TPERMALL:parseInt("0777",8),TPERMMASK:parseInt("0777",8)}});var j=N((ae,y)=>{"use strict";d();var J=_(),l=v(),Ar=512,G=l.TPERMALL,Q=0,rr=0,H=[["name",100,0,function(r,e){return z(r[e[0]],e[1])},function(r,e,t){return P(r.slice(e,e+t[1]))}],["mode",8,100,function(r,e){var t=r[e[0]]||G;return t=t&l.TPERMMASK,x(t,e[1],G)},function(r,e,t){var s=F(r.slice(e,e+t[1]));return s&=l.TPERMMASK,s}],["uid",8,108,function(r,e){return x(r[e[0]],e[1],Q)},function(r,e,t){return F(r.slice(e,e+t[1]))}],["gid",8,116,function(r,e){return x(r[e[0]],e[1],rr)},function(r,e,t){return F(r.slice(e,e+t[1]))}],["size",12,124,function(r,e){return x(r.data.length,e[1])},function(r,e,t){return F(r.slice(e,e+t[1]))}],["modifyTime",12,136,function(r,e){return O(r[e[0]],e[1])},function(r,e,t){return k(r.slice(e,e+t[1]))}],["checksum",8,148,function(r,e){return"        "},function(r,e,t){return F(r.slice(e,e+t[1]))}],["type",1,156,function(r,e){return""+(parseInt(r[e[0]],10)||0)%8},function(r,e,t){return(parseInt(String.fromCharCode(r[e]),10)||0)%8}],["linkName",100,157,function(r,e){return""},function(r,e,t){return P(r.slice(e,e+t[1]))}],["ustar",8,257,function(r,e){return l.TMAGIC},function(r,e,t){return wr(P(r.slice(e,e+t[1]),!0))},function(r,e){return r[e[0]]==l.TMAGIC||r[e[0]]==l.OLDGNU_MAGIC}],["owner",32,265,function(r,e){return z(r[e[0]],e[1])},function(r,e,t){return P(r.slice(e,e+t[1]))}],["group",32,297,function(r,e){return z(r[e[0]],e[1])},function(r,e,t){return P(r.slice(e,e+t[1]))}],["majorNumber",8,329,function(r,e){return""},function(r,e,t){return F(r.slice(e,e+t[1]))}],["minorNumber",8,337,function(r,e){return""},function(r,e,t){return F(r.slice(e,e+t[1]))}],["prefix",131,345,function(r,e){return z(r[e[0]],e[1])},function(r,e,t){return P(r.slice(e,e+t[1]))}],["accessTime",12,476,function(r,e){return O(r[e[0]],e[1])},function(r,e,t){return k(r.slice(e,e+t[1]))}],["createTime",12,488,function(r,e){return O(r[e[0]],e[1])},function(r,e,t){return k(r.slice(e,e+t[1]))}]],er=(function(r){var e=r[r.length-1];return e[2]+e[1]})(H);function wr(r){if(r.length==8){var e=r.split("");if(e[5]==l.NULL_CHAR)return(e[6]==" "||e[6]==l.NULL_CHAR)&&(e[6]="0"),(e[7]==" "||e[7]==l.NULL_CHAR)&&(e[7]="0"),e=e.join(""),e==l.TMAGIC?e:r;if(e[7]==l.NULL_CHAR)return e[5]==l.NULL_CHAR&&(e[5]=" "),e[6]==l.NULL_CHAR&&(e[6]=" "),e==l.OLDGNU_MAGIC?e:r}return r}function z(r,e){return e-=1,J.isUndefined(r)&&(r=""),r=(""+r).substr(0,e),r+l.NULL_CHAR}function x(r,e,t){for(t=parseInt(t)||0,e-=1,r=(parseInt(r)||t).toString(8).substr(-e,e);r.length<e;)r="0"+r;return r+l.NULL_CHAR}function O(r,e){if(J.isDateTime(r))r=Math.floor(1*r/1e3);else if(r=parseInt(r,10),isFinite(r)){if(r<=0)return""}else r=Math.floor(1*new Date/1e3);return x(r,e,0)}function P(r,e){var t=String.fromCharCode.apply(null,r);if(e)return t;var s=t.indexOf(l.NULL_CHAR);return s>=0?t.substr(0,s):t}function F(r){var e=String.fromCharCode.apply(null,r);return parseInt(e.replace(/^0+$/g,""),8)||0}function k(r){return r.length==0||r[0]==0?null:new Date(1e3*F(r))}function Pr(r,e,t){var s=parseInt(e,10)||0,o=Math.min(s+er,r.length),n=0,i=0,a=0;t&&H.every(function(c){return c[0]=="checksum"?(i=s+c[2],a=i+c[1],!1):!0});for(var u=32,p=s;p<o;p++){var m=p>=i&&p<a?u:r[p];n=(n+m)%262144}return n}y.exports.recordSize=Ar;y.exports.defaultFileMode=G;y.exports.defaultUid=Q;y.exports.defaultGid=rr;y.exports.posixHeader=H;y.exports.effectiveHeaderSize=er;y.exports.calculateChecksum=Pr;y.exports.formatTarString=z;y.exports.formatTarNumber=x;y.exports.formatTarDateTime=O;y.exports.parseTarString=P;y.exports.parseTarNumber=F;y.exports.parseTarDateTime=k});var or=N((ue,ir)=>{"use strict";d();var Nr=v(),I=_(),T=j();function tr(r){return T.recordSize}function nr(r){return Math.ceil(r.data.length/T.recordSize)*T.recordSize}function xr(r){var e=0;return r.forEach(function(t){e+=tr(t)+nr(t)}),e+=T.recordSize*2,new Uint8Array(e)}function Ur(r,e,t){t=parseInt(t)||0;var s=t;T.posixHeader.forEach(function(u){for(var p=u[3](e,u),m=p.length,c=0;c<m;c+=1)r[s+c]=p.charCodeAt(c)&255;s+=u[1]});var o=I.find(T.posixHeader,function(u){return u[0]=="checksum"});if(o){var n=T.calculateChecksum(r,t,!0),i=T.formatTarNumber(n,o[1]-2)+Nr.NULL_CHAR+" ";s=t+o[2];for(var a=0;a<i.length;a+=1)r[s]=i.charCodeAt(a)&255,s++}return t+tr(e)}function _r(r,e,t){return t=parseInt(t,10)||0,r.set(e.data,t),t+nr(e)}function vr(r){r=I.map(r,function(s){return I.extend({},s,{data:I.toUint8Array(s.data)})});var e=xr(r),t=0;return r.forEach(function(s){t=Ur(e,s,t),t=_r(e,s,t)}),e}ir.exports.tar=vr});var sr=N((pe,ar)=>{"use strict";d();var zr=v(),q=_(),b=j(),Cr={extractData:!0,checkHeader:!0,checkChecksum:!0,checkFileSize:!0},Dr={size:!0,checksum:!0,ustar:!0},B={unexpectedEndOfFile:"Unexpected end of file.",fileCorrupted:"File is corrupted.",checksumCheckFailed:"Checksum check failed."};function Or(r){return b.recordSize}function kr(r){return Math.ceil(r/b.recordSize)*b.recordSize}function Ir(r,e){for(var t=e,s=Math.min(r.length,e+b.recordSize*2),o=t;o<s;o++)if(r[o]!=0)return!1;return!0}function Mr(r,e,t){if(r.length-e<b.recordSize){if(t.checkFileSize)throw new Error(B.unexpectedEndOfFile);return null}e=parseInt(e)||0;var s={},o=e;if(b.posixHeader.forEach(function(a){s[a[0]]=a[4](r,o,a),o+=a[1]}),s.type!=0&&(s.size=0),t.checkHeader&&b.posixHeader.forEach(function(a){if(q.isFunction(a[5])&&!a[5](s,a)){var u=new Error(B.fileCorrupted);throw u.data={offset:e+a[2],field:a[0]},u}}),t.checkChecksum){var n=b.calculateChecksum(r,e,!0);if(n!=s.checksum){var i=new Error(B.checksumCheckFailed);throw i.data={offset:e,header:s,checksum:n},i}}return s}function Rr(r,e,t,s){return s.extractData?t.size<=0?new Uint8Array:r.slice(e,e+t.size):null}function Lr(r,e){var t={};return b.posixHeader.forEach(function(s){var o=s[0];Dr[o]||(t[o]=r[o])}),t.isOldGNUFormat=r.ustar==zr.OLDGNU_MAGIC,e&&(t.data=e),t}function Gr(r,e){e=q.extend({},Cr,e);for(var t=[],s=0,o=r.length;o-s>=b.recordSize;){r=q.toUint8Array(r);var n=Mr(r,s,e);if(!n)break;s+=Or(n);var i=Rr(r,s,n,e);if(t.push(Lr(n,i)),s+=kr(n.size),Ir(r,s))break}return t}ar.exports.untar=Gr});var cr=N((de,ur)=>{"use strict";d();var Hr=_(),jr=v(),Br=or(),qr=sr();Hr.extend(ur.exports,Br,qr,jr)});d();d();var h=gr(cr(),1);async function $(r,e,t="pgdata",s="auto"){let o=Yr(r,e),[n,i]=await Vr(o,s),a=t+(i?".tar.gz":".tar"),u=i?"application/x-gzip":"application/x-tar";return typeof File<"u"?new File([n],a,{type:u}):new Blob([n],{type:u})}var $r=["application/x-gtar","application/x-tar+gzip","application/x-gzip","application/gzip"];async function fe(r,e,t){let s=new Uint8Array(await e.arrayBuffer()),o=typeof File<"u"&&e instanceof File?e.name:void 0;($r.includes(e.type)||o?.endsWith(".tgz")||o?.endsWith(".tar.gz"))&&(s=await pr(s));let i;try{i=(0,h.untar)(s)}catch(c){if(c instanceof Error&&c.message.includes("File is corrupted"))s=await pr(s),i=(0,h.untar)(s);else throw c}let a=!1,u=0;for(let c of i){let S=t+c.name,E=S.split("/").slice(0,-1);for(let f=1;f<=E.length;f++){let U=E.slice(0,f).join("/");r.analyzePath(U).exists||r.mkdir(U)}if(c.type===h.REGTYPE){if((c.name.endsWith("pg_control")||c.name.includes("/pg_control"))&&(a=!0,u=c.data?.length??0,console.info(`[loadTar] Extracting pg_control: name="${c.name}", tarball.size=${c.size??"undefined"}, data.length=${u}, data is Uint8Array=${c.data instanceof Uint8Array}`),u>0&&u<100?console.warn("[loadTar] pg_control data is suspiciously small! First bytes:",Array.from(c.data.slice(0,Math.min(20,u))).map(f=>f.toString(16).padStart(2,"0")).join(" ")):u===0&&console.error("[loadTar] pg_control has ZERO data bytes! This will cause _pgl_backend to crash.")),r.writeFile(S,c.data),c.name.endsWith("pg_control")||c.name.includes("/pg_control"))try{let f=r.stat(S);console.info(`[loadTar] pg_control stat after write: size=${f.size}, mode=${f.mode}`),f.size===0?console.error("[loadTar] CRITICAL: pg_control has 0 bytes after FS.writeFile! Write failed silently."):f.size!==c.data.length&&console.warn(`[loadTar] pg_control size mismatch: expected ${c.data.length}, got ${f.size}`)}catch(f){console.error("[loadTar] Failed to stat pg_control after write:",f)}r.utime(S,lr(c.modifyTime),lr(c.modifyTime))}else c.type===h.DIRTYPE&&r.mkdir(S)}a?console.info(`[loadTar] pg_control extraction complete: ${u} bytes written`):console.error(`[loadTar] pg_control was NOT found in tarball! Files extracted: ${i.length}`);let p=["PG_VERSION","postgresql.conf","base","global","global/pg_control"],m=[];for(let c of p){let S=t+"/"+c;r.analyzePath(S).exists||m.push(c)}if(m.length>0){let c=`[loadTar] VALIDATION FAILED: Missing required paths: ${m.join(", ")}`;throw console.error(c),new Error(`Invalid PGlite datadir: missing required paths: ${m.join(", ")}`)}try{let c=t+"/global/pg_control",S=r.readFile(c,{encoding:"binary"}),E=S.length;if(E===0)console.error("[loadTar] pg_control file is EMPTY (0 bytes)! This will cause _pgl_backend to crash.");else if(E<20)console.error(`[loadTar] pg_control file is too small (${E} bytes, need at least 20)! Corrupt tarball?`);else{let U=new DataView(new Uint8Array(S).buffer).getUint32(16,!0);console.info(`[loadTar] pg_control state = ${U} (${{0:"DB_STARTUP",1:"DB_SHUTDOWNED",2:"DB_SHUTDOWNED_IN_RECOVERY",3:"DB_SHUTDOWNING",4:"DB_IN_CRASH_RECOVERY",5:"DB_IN_ARCHIVE_RECOVERY",6:"DB_IN_PRODUCTION"}[U]||"UNKNOWN"}), size = ${E} bytes`)}}catch(c){console.warn("[loadTar] Could not read pg_control state:",c)}console.info(`[loadTar] Validation passed: all ${p.length} required paths present`)}function Wr(r,e){let t=[],s=o=>{r.readdir(o).forEach(i=>{if(i==="."||i==="..")return;let a=o+"/"+i,u=r.stat(a),p=r.isFile(u.mode)?r.readFile(a,{encoding:"binary"}):new Uint8Array(0);t.push({name:a.substring(e.length),mode:u.mode,size:u.size,type:r.isFile(u.mode)?h.REGTYPE:h.DIRTYPE,modifyTime:u.mtime,data:p}),r.isDir(u.mode)&&s(a)})};return s(e),t}function Yr(r,e){let t=Wr(r,e);return(0,h.tar)(t)}async function Vr(r,e="auto"){if(e==="none")return[r,!1];if(typeof CompressionStream<"u")return[await Xr(r),!0];if(typeof process<"u"&&process.versions&&process.versions.node)return[await Kr(r),!0];if(e==="auto")return[r,!1];throw new Error("Compression not supported in this environment")}async function Xr(r){let e=new CompressionStream("gzip"),t=e.writable.getWriter(),s=e.readable.getReader();t.write(r),t.close();let o=[];for(;;){let{value:a,done:u}=await s.read();if(u)break;a&&o.push(a)}let n=new Uint8Array(o.reduce((a,u)=>a+u.length,0)),i=0;return o.forEach(a=>{n.set(a,i),i+=a.length}),n}async function Kr(r){let{promisify:e}=await import("util"),{gzip:t}=await import("zlib");return await e(t)(r)}async function pr(r){if(typeof CompressionStream<"u")return await Zr(r);if(typeof process<"u"&&process.versions&&process.versions.node)return await Jr(r);throw new Error("Unsupported environment for decompression")}async function Zr(r){let e=new DecompressionStream("gzip"),t=e.writable.getWriter(),s=e.readable.getReader();t.write(r),t.close();let o=[];for(;;){let{value:a,done:u}=await s.read();if(u)break;a&&o.push(a)}let n=new Uint8Array(o.reduce((a,u)=>a+u.length,0)),i=0;return o.forEach(a=>{n.set(a,i),i+=a.length}),n}async function Jr(r){let{promisify:e}=await import("util"),{gunzip:t}=await import("zlib");return await e(t)(r)}function lr(r){return r?typeof r=="number"?r:Math.floor(r.getTime()/1e3):Math.floor(Date.now()/1e3)}var Qr="/tmp/pglite",M=Qr+"/base",dr=class{constructor(e){this.dataDir=e}async init(e,t){return this.pg=e,{emscriptenOpts:t}}async syncToFs(e){}async initialSyncFs(){}async closeFs(){}async dumpTar(e,t){return $(this.pg.Module.FS,M,e,t)}},mr=class{constructor(e,{debug:t=!1}={}){this.dataDir=e,this.debug=t}async syncToFs(e){}async initialSyncFs(){}async closeFs(){}async dumpTar(e,t){return $(this.pg.Module.FS,M,e,t)}async init(e,t){return this.pg=e,{emscriptenOpts:{...t,preRun:[...t.preRun||[],o=>{let n=re(o,this);o.FS.mkdir(M),o.FS.mount(n,{},M)}]}}}},fr={EBADF:8,EBADFD:127,EEXIST:20,EINVAL:28,EISDIR:31,ENODEV:43,ENOENT:44,ENOTDIR:54,ENOTEMPTY:55},re=(r,e)=>{let t=r.FS,s=e.debug?console.log:null,o={tryFSOperation(n){try{return n()}catch(i){throw i.code?i.code==="UNKNOWN"?new t.ErrnoError(fr.EINVAL):new t.ErrnoError(i.code):i}},mount(n){return o.createNode(null,"/",16895,0)},syncfs(n,i,a){},createNode(n,i,a,u){if(!t.isDir(a)&&!t.isFile(a))throw new t.ErrnoError(28);let p=t.createNode(n,i,a);return p.node_ops=o.node_ops,p.stream_ops=o.stream_ops,p},getMode:function(n){return s?.("getMode",n),o.tryFSOperation(()=>e.lstat(n).mode)},realPath:function(n){let i=[];for(;n.parent!==n;)i.push(n.name),n=n.parent;return i.push(n.mount.opts.root),i.reverse(),i.join("/")},node_ops:{getattr(n){s?.("getattr",o.realPath(n));let i=o.realPath(n);return o.tryFSOperation(()=>{let a=e.lstat(i);return{...a,dev:0,ino:n.id,nlink:1,rdev:n.rdev,atime:new Date(a.atime),mtime:new Date(a.mtime),ctime:new Date(a.ctime)}})},setattr(n,i){s?.("setattr",o.realPath(n),i);let a=o.realPath(n);o.tryFSOperation(()=>{i.mode!==void 0&&e.chmod(a,i.mode),i.size!==void 0&&e.truncate(a,i.size),i.timestamp!==void 0&&e.utimes(a,i.timestamp,i.timestamp),i.size!==void 0&&e.truncate(a,i.size)})},lookup(n,i){s?.("lookup",o.realPath(n),i);let a=[o.realPath(n),i].join("/"),u=o.getMode(a);return o.createNode(n,i,u)},mknod(n,i,a,u){s?.("mknod",o.realPath(n),i,a,u);let p=o.createNode(n,i,a,u),m=o.realPath(p);return o.tryFSOperation(()=>(t.isDir(p.mode)?e.mkdir(m,{mode:a}):e.writeFile(m,"",{mode:a}),p))},rename(n,i,a){s?.("rename",o.realPath(n),o.realPath(i),a);let u=o.realPath(n),p=[o.realPath(i),a].join("/");o.tryFSOperation(()=>{e.rename(u,p)}),n.name=a},unlink(n,i){s?.("unlink",o.realPath(n),i);let a=[o.realPath(n),i].join("/");try{e.unlink(a)}catch{}},rmdir(n,i){s?.("rmdir",o.realPath(n),i);let a=[o.realPath(n),i].join("/");return o.tryFSOperation(()=>{e.rmdir(a)})},readdir(n){s?.("readdir",o.realPath(n));let i=o.realPath(n);return o.tryFSOperation(()=>e.readdir(i))},symlink(n,i,a){throw s?.("symlink",o.realPath(n),i,a),new t.ErrnoError(63)},readlink(n){throw s?.("readlink",o.realPath(n)),new t.ErrnoError(63)}},stream_ops:{open(n){s?.("open stream",o.realPath(n.node));let i=o.realPath(n.node);return o.tryFSOperation(()=>{t.isFile(n.node.mode)&&(n.shared.refcount=1,n.nfd=e.open(i))})},close(n){return s?.("close stream",o.realPath(n.node)),o.tryFSOperation(()=>{t.isFile(n.node.mode)&&n.nfd&&--n.shared.refcount===0&&e.close(n.nfd)})},dup(n){s?.("dup stream",o.realPath(n.node)),n.shared.refcount++},read(n,i,a,u,p){return s?.("read stream",o.realPath(n.node),a,u,p),u===0?0:o.tryFSOperation(()=>e.read(n.nfd,i,a,u,p))},write(n,i,a,u,p){return s?.("write stream",o.realPath(n.node),a,u,p),o.tryFSOperation(()=>e.write(n.nfd,i.buffer,a,u,p))},llseek(n,i,a){s?.("llseek stream",o.realPath(n.node),i,a);let u=i;if(a===1?u+=n.position:a===2&&t.isFile(n.node.mode)&&o.tryFSOperation(()=>{let p=e.fstat(n.nfd);u+=p.size}),u<0)throw new t.ErrnoError(28);return u},mmap(n,i,a,u,p){if(s?.("mmap stream",o.realPath(n.node),i,a,u,p),!t.isFile(n.node.mode))throw new t.ErrnoError(fr.ENODEV);let m=r.mmapAlloc(i);return o.stream_ops.read(n,r.HEAP8,m,i,a),{ptr:m,allocated:!0}},msync(n,i,a,u,p){return s?.("msync stream",o.realPath(n.node),a,u,p),o.stream_ops.write(n,i,0,u,a),0}}};return o};export{cr as a,fe as b,Qr as c,M as d,dr as e,mr as f,fr as g};
//# sourceMappingURL=chunk-G6E4R66U.js.map