{"version":3,"sources":["../src/string-utils.ts","../src/buffer-writer.ts","../src/serializer.ts","../src/types.ts","../src/buffer-reader.ts","../src/parser.ts"],"sourcesContent":["/**\n * Calculates the byte length of a UTF-8 encoded string\n * Adapted from https://stackoverflow.com/a/23329386\n * @param str - UTF-8 encoded string\n * @returns byte length of string\n */\nfunction byteLengthUtf8(str: string): number {\n  let byteLength = str.length\n  for (let i = str.length - 1; i >= 0; i--) {\n    const code = str.charCodeAt(i)\n    if (code > 0x7f && code <= 0x7ff) byteLength++\n    else if (code > 0x7ff && code <= 0xffff) byteLength += 2\n    if (code >= 0xdc00 && code <= 0xdfff) i-- // trail surrogate\n  }\n  return byteLength\n}\n\nexport { byteLengthUtf8 }\n","import { byteLengthUtf8 } from './string-utils'\n\nexport class Writer {\n  #bufferView: DataView\n  #offset: number = 5\n\n  readonly #littleEndian = false as const\n  readonly #encoder = new TextEncoder()\n  readonly #headerPosition: number = 0\n  constructor(private size = 256) {\n    this.#bufferView = this.#allocateBuffer(size)\n  }\n\n  #allocateBuffer(size: number): DataView {\n    return new DataView(new ArrayBuffer(size))\n  }\n\n  #ensure(size: number): void {\n    const remaining = this.#bufferView.byteLength - this.#offset\n    if (remaining < size) {\n      const oldBuffer = this.#bufferView.buffer\n      // exponential growth factor of around ~ 1.5\n      // https://stackoverflow.com/questions/2269063/buffer-growth-strategy\n      const newSize = oldBuffer.byteLength + (oldBuffer.byteLength >> 1) + size\n      this.#bufferView = this.#allocateBuffer(newSize)\n      new Uint8Array(this.#bufferView.buffer).set(new Uint8Array(oldBuffer))\n    }\n  }\n\n  public addInt32(num: number): Writer {\n    this.#ensure(4)\n    this.#bufferView.setInt32(this.#offset, num, this.#littleEndian)\n    this.#offset += 4\n    return this\n  }\n\n  public addInt16(num: number): Writer {\n    this.#ensure(2)\n    this.#bufferView.setInt16(this.#offset, num, this.#littleEndian)\n    this.#offset += 2\n    return this\n  }\n\n  public addCString(string: string): Writer {\n    if (string) {\n      // TODO(msfstef): might be faster to extract `addString` code and\n      // ensure length + 1 once rather than length and then +1?\n      this.addString(string)\n    }\n\n    // set null terminator\n    this.#ensure(1)\n    this.#bufferView.setUint8(this.#offset, 0)\n    this.#offset++\n    return this\n  }\n\n  public addString(string: string = ''): Writer {\n    const length = byteLengthUtf8(string)\n    this.#ensure(length)\n    this.#encoder.encodeInto(\n      string,\n      new Uint8Array(this.#bufferView.buffer, this.#offset),\n    )\n    this.#offset += length\n    return this\n  }\n\n  public add(otherBuffer: ArrayBuffer | Uint8Array): Writer {\n    const buffer =\n      otherBuffer instanceof Uint8Array\n        ? (otherBuffer.buffer as ArrayBuffer).slice(\n            otherBuffer.byteOffset,\n            otherBuffer.byteOffset + otherBuffer.byteLength,\n          )\n        : otherBuffer\n    this.#ensure(buffer.byteLength)\n    new Uint8Array(this.#bufferView.buffer).set(\n      new Uint8Array(buffer),\n      this.#offset,\n    )\n\n    this.#offset += buffer.byteLength\n    return this\n  }\n\n  #join(code?: number): ArrayBuffer {\n    if (code) {\n      this.#bufferView.setUint8(this.#headerPosition, code)\n      // length is everything in this packet minus the code\n      const length = this.#offset - (this.#headerPosition + 1)\n      this.#bufferView.setInt32(\n        this.#headerPosition + 1,\n        length,\n        this.#littleEndian,\n      )\n    }\n    return this.#bufferView.buffer.slice(code ? 0 : 5, this.#offset)\n  }\n\n  public flush(code?: number): Uint8Array {\n    const result = this.#join(code)\n    this.#offset = 5\n    this.#bufferView = this.#allocateBuffer(this.size)\n    return new Uint8Array(result)\n  }\n}\n","import { Writer } from './buffer-writer'\nimport { byteLengthUtf8 } from './string-utils'\n\nconst enum code {\n  startup = 0x70,\n  query = 0x51,\n  parse = 0x50,\n  bind = 0x42,\n  execute = 0x45,\n  flush = 0x48,\n  sync = 0x53,\n  end = 0x58,\n  close = 0x43,\n  describe = 0x44,\n  copyFromChunk = 0x64,\n  copyDone = 0x63,\n  copyFail = 0x66,\n}\n\ntype LegalValue = string | ArrayBuffer | ArrayBufferView | null\n\nconst writer = new Writer()\n\nconst startup = (opts: Record<string, string>): Uint8Array => {\n  // protocol version\n  writer.addInt16(3).addInt16(0)\n  for (const key of Object.keys(opts)) {\n    writer.addCString(key).addCString(opts[key])\n  }\n\n  writer.addCString('client_encoding').addCString('UTF8')\n\n  const bodyBuffer = writer.addCString('').flush()\n  // this message is sent without a code\n\n  const length = bodyBuffer.byteLength + 4\n\n  return new Writer().addInt32(length).add(bodyBuffer).flush()\n}\n\nconst requestSsl = (): Uint8Array => {\n  const bufferView = new DataView(new ArrayBuffer(8))\n  bufferView.setInt32(0, 8, false)\n  bufferView.setInt32(4, 80877103, false)\n  return new Uint8Array(bufferView.buffer)\n}\n\nconst password = (password: string): Uint8Array => {\n  return writer.addCString(password).flush(code.startup)\n}\n\nconst sendSASLInitialResponseMessage = (\n  mechanism: string,\n  initialResponse: string,\n): Uint8Array => {\n  // 0x70 = 'p'\n  writer\n    .addCString(mechanism)\n    .addInt32(byteLengthUtf8(initialResponse))\n    .addString(initialResponse)\n\n  return writer.flush(code.startup)\n}\n\nconst sendSCRAMClientFinalMessage = (additionalData: string): Uint8Array => {\n  return writer.addString(additionalData).flush(code.startup)\n}\n\nconst query = (text: string): Uint8Array => {\n  return writer.addCString(text).flush(code.query)\n}\n\ntype ParseOpts = {\n  name?: string\n  types?: number[]\n  text: string\n}\n\nconst emptyValueArray: LegalValue[] = []\n\nconst parse = (query: ParseOpts): Uint8Array => {\n  // expect something like this:\n  // { name: 'queryName',\n  //   text: 'select * from blah',\n  //   types: ['int8', 'bool'] }\n\n  // normalize missing query names to allow for null\n  const name = query.name ?? ''\n  if (name.length > 63) {\n    /* eslint-disable no-console */\n    console.error(\n      'Warning! Postgres only supports 63 characters for query names.',\n    )\n    console.error('You supplied %s (%s)', name, name.length)\n    console.error(\n      'This can cause conflicts and silent errors executing queries',\n    )\n    /* eslint-enable no-console */\n  }\n\n  const buffer = writer\n    .addCString(name) // name of query\n    .addCString(query.text) // actual query text\n    .addInt16(query.types?.length ?? 0)\n\n  query.types?.forEach((type) => buffer.addInt32(type))\n\n  return writer.flush(code.parse)\n}\n\ntype ValueMapper = (param: unknown, index: number) => LegalValue\n\ntype BindOpts = {\n  portal?: string\n  binary?: boolean\n  statement?: string\n  values?: LegalValue[]\n  // optional map from JS value to postgres value per parameter\n  valueMapper?: ValueMapper\n}\n\nconst paramWriter = new Writer()\n\n// make this a const enum so typescript will inline the value\nconst enum ParamType {\n  STRING = 0,\n  BINARY = 1,\n}\n\nconst writeValues = (values: LegalValue[], valueMapper?: ValueMapper): void => {\n  for (let i = 0; i < values.length; i++) {\n    const mappedVal = valueMapper ? valueMapper(values[i], i) : values[i]\n    if (mappedVal === null) {\n      // add the param type (string) to the writer\n      writer.addInt16(ParamType.STRING)\n      // write -1 to the param writer to indicate null\n      paramWriter.addInt32(-1)\n    } else if (\n      mappedVal instanceof ArrayBuffer ||\n      ArrayBuffer.isView(mappedVal)\n    ) {\n      const buffer = ArrayBuffer.isView(mappedVal)\n        ? (mappedVal.buffer as ArrayBuffer).slice(\n            mappedVal.byteOffset,\n            mappedVal.byteOffset + mappedVal.byteLength,\n          )\n        : mappedVal\n      // add the param type (binary) to the writer\n      writer.addInt16(ParamType.BINARY)\n      // add the buffer to the param writer\n      paramWriter.addInt32(buffer.byteLength)\n      paramWriter.add(buffer)\n    } else {\n      // add the param type (string) to the writer\n      writer.addInt16(ParamType.STRING)\n      paramWriter.addInt32(byteLengthUtf8(mappedVal))\n      paramWriter.addString(mappedVal)\n    }\n  }\n}\n\nconst bind = (config: BindOpts = {}): Uint8Array => {\n  // normalize config\n  const portal = config.portal ?? ''\n  const statement = config.statement ?? ''\n  const binary = config.binary ?? false\n  const values = config.values ?? emptyValueArray\n  const len = values.length\n\n  writer.addCString(portal).addCString(statement)\n  writer.addInt16(len)\n\n  writeValues(values, config.valueMapper)\n\n  writer.addInt16(len)\n  writer.add(paramWriter.flush())\n\n  // format code\n  writer.addInt16(binary ? ParamType.BINARY : ParamType.STRING)\n  return writer.flush(code.bind)\n}\n\ntype ExecOpts = {\n  portal?: string\n  rows?: number\n}\n\nconst emptyExecute = new Uint8Array([\n  code.execute,\n  0x00,\n  0x00,\n  0x00,\n  0x09,\n  0x00,\n  0x00,\n  0x00,\n  0x00,\n  0x00,\n])\n\nconst execute = (config?: ExecOpts): Uint8Array => {\n  // this is the happy path for most queries\n  if (!config || (!config.portal && !config.rows)) {\n    return emptyExecute\n  }\n\n  const portal = config.portal ?? ''\n  const rows = config.rows ?? 0\n\n  const portalLength = byteLengthUtf8(portal)\n  const len = 4 + portalLength + 1 + 4\n  // one extra bit for code\n  const bufferView = new DataView(new ArrayBuffer(1 + len))\n  bufferView.setUint8(0, code.execute)\n  bufferView.setInt32(1, len, false)\n  new TextEncoder().encodeInto(portal, new Uint8Array(bufferView.buffer, 5))\n  bufferView.setUint8(portalLength + 5, 0) // null terminate portal cString\n  bufferView.setUint32(bufferView.byteLength - 4, rows, false)\n  return new Uint8Array(bufferView.buffer)\n}\n\nconst cancel = (processID: number, secretKey: number): Uint8Array => {\n  const bufferView = new DataView(new ArrayBuffer(16))\n  bufferView.setInt32(0, 16, false)\n  bufferView.setInt16(4, 1234, false)\n  bufferView.setInt16(6, 5678, false)\n  bufferView.setInt32(8, processID, false)\n  bufferView.setInt32(12, secretKey, false)\n  return new Uint8Array(bufferView.buffer)\n}\n\ntype PortalOpts = {\n  type: 'S' | 'P'\n  name?: string\n}\n\nconst cstringMessage = (code: code, string: string): Uint8Array => {\n  const writer = new Writer()\n  writer.addCString(string)\n  return writer.flush(code)\n}\n\nconst emptyDescribePortal = writer.addCString('P').flush(code.describe)\nconst emptyDescribeStatement = writer.addCString('S').flush(code.describe)\n\nconst describe = (msg: PortalOpts): Uint8Array => {\n  return msg.name\n    ? cstringMessage(code.describe, `${msg.type}${msg.name ?? ''}`)\n    : msg.type === 'P'\n      ? emptyDescribePortal\n      : emptyDescribeStatement\n}\n\nconst close = (msg: PortalOpts): Uint8Array => {\n  const text = `${msg.type}${msg.name ?? ''}`\n  return cstringMessage(code.close, text)\n}\n\nconst copyData = (chunk: ArrayBuffer): Uint8Array => {\n  return writer.add(chunk).flush(code.copyFromChunk)\n}\n\nconst copyFail = (message: string): Uint8Array => {\n  return cstringMessage(code.copyFail, message)\n}\n\nconst codeOnlyBuffer = (code: code): Uint8Array =>\n  new Uint8Array([code, 0x00, 0x00, 0x00, 0x04])\n\nconst flushBuffer = codeOnlyBuffer(code.flush)\nconst syncBuffer = codeOnlyBuffer(code.sync)\nconst endBuffer = codeOnlyBuffer(code.end)\nconst copyDoneBuffer = codeOnlyBuffer(code.copyDone)\n\nconst serialize = {\n  startup,\n  password,\n  requestSsl,\n  sendSASLInitialResponseMessage,\n  sendSCRAMClientFinalMessage,\n  query,\n  parse,\n  bind,\n  execute,\n  describe,\n  close,\n  flush: () => flushBuffer,\n  sync: () => syncBuffer,\n  end: () => endBuffer,\n  copyData,\n  copyDone: () => copyDoneBuffer,\n  copyFail,\n  cancel,\n}\n\nexport { serialize }\n","export const Modes = {\n  text: 0,\n  binary: 1,\n} as const\n\nexport type Mode = (typeof Modes)[keyof typeof Modes]\n\nexport type BufferParameter = ArrayBuffer | ArrayBufferView\n","const emptyBuffer = new ArrayBuffer(0)\n\nexport class BufferReader {\n  #bufferView: DataView = new DataView(emptyBuffer)\n  #offset: number\n\n  // TODO(bmc): support non-utf8 encoding?\n  readonly #encoding: string = 'utf-8' as const\n  readonly #decoder = new TextDecoder(this.#encoding)\n  readonly #littleEndian: boolean = false as const\n\n  constructor(offset: number = 0) {\n    this.#offset = offset\n  }\n\n  public setBuffer(offset: number, buffer: ArrayBuffer): void {\n    this.#offset = offset\n    this.#bufferView = new DataView(buffer)\n  }\n\n  public int16(): number {\n    // const result = this.buffer.readInt16BE(this.#offset)\n    const result = this.#bufferView.getInt16(this.#offset, this.#littleEndian)\n    this.#offset += 2\n    return result\n  }\n\n  public byte(): number {\n    // const result = this.bufferView[this.#offset]\n    const result = this.#bufferView.getUint8(this.#offset)\n    this.#offset++\n    return result\n  }\n\n  public int32(): number {\n    // const result = this.buffer.readInt32BE(this.#offset)\n    const result = this.#bufferView.getInt32(this.#offset, this.#littleEndian)\n    this.#offset += 4\n    return result\n  }\n\n  public string(length: number): string {\n    // const result = this.#bufferView.toString(\n    //   this.#encoding,\n    //   this.#offset,\n    //   this.#offset + length,\n    // )\n    // this.#offset += length\n\n    const result = this.#decoder.decode(this.bytes(length))\n    return result\n  }\n\n  public cstring(): string {\n    // const start = this.#offset\n    // let end = start\n    // while (this.#bufferView[end++] !== 0) {}\n\n    const start = this.#offset\n    let end = start\n    while (this.#bufferView.getUint8(end++) !== 0) {\n      // no-op - increment until terminator reached\n    }\n    const result = this.string(end - start - 1)\n    this.#offset = end\n    return result\n  }\n\n  public bytes(length: number): Uint8Array {\n    // const result = this.buffer.slice(this.#offset, this.#offset + length)\n    const result = this.#bufferView.buffer.slice(\n      this.#offset,\n      this.#offset + length,\n    )\n    this.#offset += length\n    return new Uint8Array(result)\n  }\n}\n","import {\n  bindComplete,\n  parseComplete,\n  closeComplete,\n  noData,\n  portalSuspended,\n  copyDone,\n  replicationStart,\n  emptyQuery,\n  ReadyForQueryMessage,\n  CommandCompleteMessage,\n  CopyDataMessage,\n  CopyResponse,\n  NotificationResponseMessage,\n  RowDescriptionMessage,\n  ParameterDescriptionMessage,\n  Field,\n  DataRowMessage,\n  ParameterStatusMessage,\n  BackendKeyDataMessage,\n  DatabaseError,\n  BackendMessage,\n  MessageName,\n  NoticeMessage,\n  AuthenticationMessage,\n  AuthenticationOk,\n  AuthenticationCleartextPassword,\n  AuthenticationMD5Password,\n  AuthenticationSASL,\n  AuthenticationSASLContinue,\n  AuthenticationSASLFinal,\n} from './messages'\nimport { BufferParameter, Modes } from './types'\nimport { BufferReader } from './buffer-reader'\n\n// every message is prefixed with a single bye\nconst CODE_LENGTH = 1 as const\n// every message has an int32 length which includes itself but does\n// NOT include the code in the length\nconst LEN_LENGTH = 4 as const\n\nconst HEADER_LENGTH = CODE_LENGTH + LEN_LENGTH\n\nexport type Packet = {\n  code: number\n  packet: ArrayBuffer\n}\n\nconst emptyBuffer = new ArrayBuffer(0)\n\nconst enum MessageCodes {\n  DataRow = 0x44, // D\n  ParseComplete = 0x31, // 1\n  BindComplete = 0x32, // 2\n  CloseComplete = 0x33, // 3\n  CommandComplete = 0x43, // C\n  ReadyForQuery = 0x5a, // Z\n  NoData = 0x6e, // n\n  NotificationResponse = 0x41, // A\n  AuthenticationResponse = 0x52, // R\n  ParameterStatus = 0x53, // S\n  BackendKeyData = 0x4b, // K\n  ErrorMessage = 0x45, // E\n  NoticeMessage = 0x4e, // N\n  RowDescriptionMessage = 0x54, // T\n  ParameterDescriptionMessage = 0x74, // t\n  PortalSuspended = 0x73, // s\n  ReplicationStart = 0x57, // W\n  EmptyQuery = 0x49, // I\n  CopyIn = 0x47, // G\n  CopyOut = 0x48, // H\n  CopyDone = 0x63, // c\n  CopyData = 0x64, // d\n}\n\nexport type MessageCallback = (msg: BackendMessage) => void\n\nexport class Parser {\n  #bufferView: DataView = new DataView(emptyBuffer)\n  #bufferRemainingLength: number = 0\n  #bufferOffset: number = 0\n  #reader = new BufferReader()\n\n  public parse(buffer: BufferParameter, callback: MessageCallback) {\n    this.#mergeBuffer(\n      ArrayBuffer.isView(buffer)\n        ? (buffer.buffer as ArrayBuffer).slice(\n            buffer.byteOffset,\n            buffer.byteOffset + buffer.byteLength,\n          )\n        : buffer,\n    )\n    const bufferFullLength = this.#bufferOffset + this.#bufferRemainingLength\n    let offset = this.#bufferOffset\n    while (offset + HEADER_LENGTH <= bufferFullLength) {\n      // code is 1 byte long - it identifies the message type\n      const code = this.#bufferView.getUint8(offset)\n      // length is 1 Uint32BE - it is the length of the message EXCLUDING the code\n      const length = this.#bufferView.getUint32(offset + CODE_LENGTH, false)\n      const fullMessageLength = CODE_LENGTH + length\n      if (fullMessageLength + offset <= bufferFullLength && length > 0) {\n        const message = this.#handlePacket(\n          offset + HEADER_LENGTH,\n          code,\n          length,\n          this.#bufferView.buffer as ArrayBuffer,\n        )\n        callback(message)\n        offset += fullMessageLength\n      } else {\n        break\n      }\n    }\n    if (offset === bufferFullLength) {\n      // No more use for the buffer\n      this.#bufferView = new DataView(emptyBuffer)\n      this.#bufferRemainingLength = 0\n      this.#bufferOffset = 0\n    } else {\n      // Adjust the cursors of remainingBuffer\n      this.#bufferRemainingLength = bufferFullLength - offset\n      this.#bufferOffset = offset\n    }\n  }\n\n  #mergeBuffer(buffer: ArrayBuffer): void {\n    if (this.#bufferRemainingLength > 0) {\n      const newLength = this.#bufferRemainingLength + buffer.byteLength\n      const newFullLength = newLength + this.#bufferOffset\n      if (newFullLength > this.#bufferView.byteLength) {\n        // We can't concat the new buffer with the remaining one\n        let newBuffer: ArrayBuffer\n        if (\n          newLength <= this.#bufferView.byteLength &&\n          this.#bufferOffset >= this.#bufferRemainingLength\n        ) {\n          // We can move the relevant part to the beginning of the buffer instead of allocating a new buffer\n          newBuffer = this.#bufferView.buffer as ArrayBuffer\n        } else {\n          // Allocate a new larger buffer\n          let newBufferLength = this.#bufferView.byteLength * 2\n          while (newLength >= newBufferLength) {\n            newBufferLength *= 2\n          }\n          newBuffer = new ArrayBuffer(newBufferLength)\n        }\n        // Move the remaining buffer to the new one\n        new Uint8Array(newBuffer).set(\n          new Uint8Array(\n            this.#bufferView.buffer,\n            this.#bufferOffset,\n            this.#bufferRemainingLength,\n          ),\n        )\n        this.#bufferView = new DataView(newBuffer)\n        this.#bufferOffset = 0\n      }\n\n      // Concat the new buffer with the remaining one\n      new Uint8Array(this.#bufferView.buffer).set(\n        new Uint8Array(buffer),\n        this.#bufferOffset + this.#bufferRemainingLength,\n      )\n      this.#bufferRemainingLength = newLength\n    } else {\n      this.#bufferView = new DataView(buffer)\n      this.#bufferOffset = 0\n      this.#bufferRemainingLength = buffer.byteLength\n    }\n  }\n\n  #handlePacket(\n    offset: number,\n    code: number,\n    length: number,\n    bytes: ArrayBuffer,\n  ): BackendMessage {\n    switch (code) {\n      case MessageCodes.BindComplete:\n        return bindComplete\n      case MessageCodes.ParseComplete:\n        return parseComplete\n      case MessageCodes.CloseComplete:\n        return closeComplete\n      case MessageCodes.NoData:\n        return noData\n      case MessageCodes.PortalSuspended:\n        return portalSuspended\n      case MessageCodes.CopyDone:\n        return copyDone\n      case MessageCodes.ReplicationStart:\n        return replicationStart\n      case MessageCodes.EmptyQuery:\n        return emptyQuery\n      case MessageCodes.DataRow:\n        return this.#parseDataRowMessage(offset, length, bytes)\n      case MessageCodes.CommandComplete:\n        return this.#parseCommandCompleteMessage(offset, length, bytes)\n      case MessageCodes.ReadyForQuery:\n        return this.#parseReadyForQueryMessage(offset, length, bytes)\n      case MessageCodes.NotificationResponse:\n        return this.#parseNotificationMessage(offset, length, bytes)\n      case MessageCodes.AuthenticationResponse:\n        return this.#parseAuthenticationResponse(offset, length, bytes)\n      case MessageCodes.ParameterStatus:\n        return this.#parseParameterStatusMessage(offset, length, bytes)\n      case MessageCodes.BackendKeyData:\n        return this.#parseBackendKeyData(offset, length, bytes)\n      case MessageCodes.ErrorMessage:\n        return this.#parseErrorMessage(offset, length, bytes, 'error')\n      case MessageCodes.NoticeMessage:\n        return this.#parseErrorMessage(offset, length, bytes, 'notice')\n      case MessageCodes.RowDescriptionMessage:\n        return this.#parseRowDescriptionMessage(offset, length, bytes)\n      case MessageCodes.ParameterDescriptionMessage:\n        return this.#parseParameterDescriptionMessage(offset, length, bytes)\n      case MessageCodes.CopyIn:\n        return this.#parseCopyInMessage(offset, length, bytes)\n      case MessageCodes.CopyOut:\n        return this.#parseCopyOutMessage(offset, length, bytes)\n      case MessageCodes.CopyData:\n        return this.#parseCopyData(offset, length, bytes)\n      default:\n        return new DatabaseError(\n          'received invalid response: ' + code.toString(16),\n          length,\n          'error',\n        )\n    }\n  }\n\n  #parseReadyForQueryMessage(\n    offset: number,\n    length: number,\n    bytes: ArrayBuffer,\n  ) {\n    this.#reader.setBuffer(offset, bytes)\n    const status = this.#reader.string(1)\n    return new ReadyForQueryMessage(length, status)\n  }\n\n  #parseCommandCompleteMessage(\n    offset: number,\n    length: number,\n    bytes: ArrayBuffer,\n  ) {\n    this.#reader.setBuffer(offset, bytes)\n    const text = this.#reader.cstring()\n    return new CommandCompleteMessage(length, text)\n  }\n\n  #parseCopyData(offset: number, length: number, bytes: ArrayBuffer) {\n    const chunk = bytes.slice(offset, offset + (length - 4))\n    return new CopyDataMessage(length, new Uint8Array(chunk))\n  }\n\n  #parseCopyInMessage(offset: number, length: number, bytes: ArrayBuffer) {\n    return this.#parseCopyMessage(offset, length, bytes, 'copyInResponse')\n  }\n\n  #parseCopyOutMessage(offset: number, length: number, bytes: ArrayBuffer) {\n    return this.#parseCopyMessage(offset, length, bytes, 'copyOutResponse')\n  }\n\n  #parseCopyMessage(\n    offset: number,\n    length: number,\n    bytes: ArrayBuffer,\n    messageName: MessageName,\n  ) {\n    this.#reader.setBuffer(offset, bytes)\n    const isBinary = this.#reader.byte() !== 0\n    const columnCount = this.#reader.int16()\n    const message = new CopyResponse(length, messageName, isBinary, columnCount)\n    for (let i = 0; i < columnCount; i++) {\n      message.columnTypes[i] = this.#reader.int16()\n    }\n    return message\n  }\n\n  #parseNotificationMessage(\n    offset: number,\n    length: number,\n    bytes: ArrayBuffer,\n  ) {\n    this.#reader.setBuffer(offset, bytes)\n    const processId = this.#reader.int32()\n    const channel = this.#reader.cstring()\n    const payload = this.#reader.cstring()\n    return new NotificationResponseMessage(length, processId, channel, payload)\n  }\n\n  #parseRowDescriptionMessage(\n    offset: number,\n    length: number,\n    bytes: ArrayBuffer,\n  ) {\n    this.#reader.setBuffer(offset, bytes)\n    const fieldCount = this.#reader.int16()\n    const message = new RowDescriptionMessage(length, fieldCount)\n    for (let i = 0; i < fieldCount; i++) {\n      message.fields[i] = this.#parseField()\n    }\n    return message\n  }\n\n  #parseField(): Field {\n    const name = this.#reader.cstring()\n    const tableID = this.#reader.int32()\n    const columnID = this.#reader.int16()\n    const dataTypeID = this.#reader.int32()\n    const dataTypeSize = this.#reader.int16()\n    const dataTypeModifier = this.#reader.int32()\n    const mode = this.#reader.int16() === 0 ? Modes.text : Modes.binary\n    return new Field(\n      name,\n      tableID,\n      columnID,\n      dataTypeID,\n      dataTypeSize,\n      dataTypeModifier,\n      mode,\n    )\n  }\n\n  #parseParameterDescriptionMessage(\n    offset: number,\n    length: number,\n    bytes: ArrayBuffer,\n  ) {\n    this.#reader.setBuffer(offset, bytes)\n    const parameterCount = this.#reader.int16()\n    const message = new ParameterDescriptionMessage(length, parameterCount)\n    for (let i = 0; i < parameterCount; i++) {\n      message.dataTypeIDs[i] = this.#reader.int32()\n    }\n    return message\n  }\n\n  #parseDataRowMessage(offset: number, length: number, bytes: ArrayBuffer) {\n    this.#reader.setBuffer(offset, bytes)\n    const fieldCount = this.#reader.int16()\n    const fields: (string | null)[] = new Array(fieldCount)\n    for (let i = 0; i < fieldCount; i++) {\n      const len = this.#reader.int32()\n      // a -1 for length means the value of the field is null\n      fields[i] = len === -1 ? null : this.#reader.string(len)\n    }\n    return new DataRowMessage(length, fields)\n  }\n\n  #parseParameterStatusMessage(\n    offset: number,\n    length: number,\n    bytes: ArrayBuffer,\n  ) {\n    this.#reader.setBuffer(offset, bytes)\n    const name = this.#reader.cstring()\n    const value = this.#reader.cstring()\n    return new ParameterStatusMessage(length, name, value)\n  }\n\n  #parseBackendKeyData(offset: number, length: number, bytes: ArrayBuffer) {\n    this.#reader.setBuffer(offset, bytes)\n    const processID = this.#reader.int32()\n    const secretKey = this.#reader.int32()\n    return new BackendKeyDataMessage(length, processID, secretKey)\n  }\n\n  #parseAuthenticationResponse(\n    offset: number,\n    length: number,\n    bytes: ArrayBuffer,\n  ): AuthenticationMessage {\n    this.#reader.setBuffer(offset, bytes)\n    const code = this.#reader.int32()\n    switch (code) {\n      case 0:\n        return new AuthenticationOk(length)\n      case 3:\n        return new AuthenticationCleartextPassword(length)\n\n      case 5:\n        return new AuthenticationMD5Password(length, this.#reader.bytes(4))\n\n      case 10: {\n        const mechanisms: string[] = []\n        while (true) {\n          const mechanism = this.#reader.cstring()\n          if (mechanism.length === 0) {\n            return new AuthenticationSASL(length, mechanisms)\n          }\n          mechanisms.push(mechanism)\n        }\n      }\n      case 11:\n        return new AuthenticationSASLContinue(\n          length,\n          this.#reader.string(length - 8),\n        )\n\n      case 12:\n        return new AuthenticationSASLFinal(\n          length,\n          this.#reader.string(length - 8),\n        )\n\n      default:\n        throw new Error('Unknown authenticationOk message type ' + code)\n    }\n  }\n\n  #parseErrorMessage(\n    offset: number,\n    length: number,\n    bytes: ArrayBuffer,\n    name: MessageName,\n  ) {\n    this.#reader.setBuffer(offset, bytes)\n    const fields: Record<string, string> = {}\n    let fieldType = this.#reader.string(1)\n    while (fieldType !== '\\0') {\n      fields[fieldType] = this.#reader.cstring()\n      fieldType = this.#reader.string(1)\n    }\n\n    const messageValue = fields.M\n\n    const message =\n      name === 'notice'\n        ? new NoticeMessage(length, messageValue)\n        : new DatabaseError(messageValue, length, name)\n\n    message.severity = fields.S\n    message.code = fields.C\n    message.detail = fields.D\n    message.hint = fields.H\n    message.position = fields.P\n    message.internalPosition = fields.p\n    message.internalQuery = fields.q\n    message.where = fields.W\n    message.schema = fields.s\n    message.table = fields.t\n    message.column = fields.c\n    message.dataType = fields.d\n    message.constraint = fields.n\n    message.file = fields.F\n    message.line = fields.L\n    message.routine = fields.R\n    return message\n  }\n}\n"],"mappings":"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","names":["byteLengthUtf8","str","byteLength","i","code","_bufferView","_offset","_littleEndian","_encoder","_headerPosition","_Writer_instances","allocateBuffer_fn","ensure_fn","join_fn","Writer","size","__privateAdd","__privateSet","__privateMethod","num","__privateGet","string","__privateWrapper","length","byteLengthUtf8","otherBuffer","buffer","code","result","oldBuffer","newSize","writer","Writer","startup","opts","key","bodyBuffer","length","requestSsl","bufferView","password","sendSASLInitialResponseMessage","mechanism","initialResponse","byteLengthUtf8","sendSCRAMClientFinalMessage","additionalData","query","text","emptyValueArray","parse","name","buffer","type","paramWriter","writeValues","values","valueMapper","i","mappedVal","writer","paramWriter","buffer","byteLengthUtf8","bind","config","portal","statement","binary","emptyValueArray","len","emptyExecute","execute","rows","portalLength","bufferView","cancel","processID","secretKey","cstringMessage","code","string","Writer","emptyDescribePortal","emptyDescribeStatement","describe","msg","close","text","copyData","chunk","copyFail","message","codeOnlyBuffer","flushBuffer","syncBuffer","endBuffer","copyDoneBuffer","serialize","startup","password","requestSsl","sendSASLInitialResponseMessage","sendSCRAMClientFinalMessage","query","parse","Modes","emptyBuffer","_bufferView","_offset","_encoding","_decoder","_littleEndian","BufferReader","offset","__privateAdd","__privateGet","__privateSet","buffer","result","__privateWrapper","length","start","end","CODE_LENGTH","LEN_LENGTH","HEADER_LENGTH","emptyBuffer","_bufferView","_bufferRemainingLength","_bufferOffset","_reader","_Parser_instances","mergeBuffer_fn","handlePacket_fn","parseReadyForQueryMessage_fn","parseCommandCompleteMessage_fn","parseCopyData_fn","parseCopyInMessage_fn","parseCopyOutMessage_fn","parseCopyMessage_fn","parseNotificationMessage_fn","parseRowDescriptionMessage_fn","parseField_fn","parseParameterDescriptionMessage_fn","parseDataRowMessage_fn","parseParameterStatusMessage_fn","parseBackendKeyData_fn","parseAuthenticationResponse_fn","parseErrorMessage_fn","Parser","__privateAdd","emptyBuffer","BufferReader","buffer","callback","__privateMethod","bufferFullLength","__privateGet","offset","HEADER_LENGTH","code","length","CODE_LENGTH","fullMessageLength","message","__privateSet","newLength","newBuffer","newBufferLength","bytes","bindComplete","parseComplete","closeComplete","noData","portalSuspended","copyDone","replicationStart","emptyQuery","DatabaseError","status","ReadyForQueryMessage","text","CommandCompleteMessage","chunk","CopyDataMessage","messageName","isBinary","columnCount","CopyResponse","i","processId","channel","payload","NotificationResponseMessage","fieldCount","RowDescriptionMessage","name","tableID","columnID","dataTypeID","dataTypeSize","dataTypeModifier","mode","Modes","Field","parameterCount","ParameterDescriptionMessage","fields","len","DataRowMessage","value","ParameterStatusMessage","processID","secretKey","BackendKeyDataMessage","AuthenticationOk","AuthenticationCleartextPassword","AuthenticationMD5Password","mechanisms","mechanism","AuthenticationSASL","AuthenticationSASLContinue","AuthenticationSASLFinal","fieldType","messageValue","NoticeMessage"]}